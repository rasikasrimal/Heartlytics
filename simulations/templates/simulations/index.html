{% extends "base.html" %}
{% block title %}Simulations{% endblock %}
{% block head %}
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" defer></script>
{% endblock %}
{% block content %}
<h1 class="mb-4">Simulations</h1>
<form method="post" class="row g-3 mb-4">
  <div class="col-md-3">
    <label class="form-label">Age</label>
    <input type="number" class="form-control" name="age" value="{{ baseline.age }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Sex</label>
    <select class="form-select" name="sex">
      <option value="1" {% if baseline.sex==1 %}selected{% endif %}>1</option>
      <option value="0" {% if baseline.sex==0 %}selected{% endif %}>0</option>
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Chest Pain Type</label>
    <select class="form-select" name="chest_pain_type">
      {% set cpt = baseline.chest_pain_type %}
      {% for v in ['typical_angina','atypical_angina','non-anginal','asymptomatic'] %}
      <option value="{{ v }}" {% if cpt==v %}selected{% endif %}>{{ v }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Country</label>
    <select class="form-select" name="country">
      {% set country = request.form.get('country','Cleveland') %}
      {% for v in ['Cleveland','Hungary','Switzerland','Long_Beach'] %}
      <option value="{{ v }}" {% if country==v %}selected{% endif %}>{{ v }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Resting BP</label>
    <input type="number" class="form-control" name="resting_blood_pressure" value="{{ baseline.resting_blood_pressure }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Cholesterol</label>
    <input type="number" class="form-control" name="cholesterol" value="{{ baseline.cholesterol }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Fasting Blood Sugar / Glucose (mg/dL)</label>
    <input type="number" class="form-control" name="fasting_blood_sugar" value="{{ baseline.fasting_blood_sugar }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Resting ECG</label>
    <select class="form-select" name="Restecg">
      {% set recg = baseline.Restecg %}
      {% for v in ['normal','left_ventricular_hypertrophy','st_t_wave_abnormality'] %}
      <option value="{{ v }}" {% if recg==v %}selected{% endif %}>{{ v }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Max Heart Rate</label>
    <input type="number" class="form-control" name="max_heart_rate_achieved" value="{{ baseline.max_heart_rate_achieved }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Exercise Angina</label>
    <select class="form-select" name="exercise_induced_angina">
      <option value="0" {% if baseline.exercise_induced_angina==0 %}selected{% endif %}>0</option>
      <option value="1" {% if baseline.exercise_induced_angina==1 %}selected{% endif %}>1</option>
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">ST Depression</label>
    <input type="number" step="0.1" class="form-control" name="st_depression" value="{{ baseline.st_depression }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">ST Slope Type</label>
    <select class="form-select" name="st_slope_type">
      {% set slope = baseline.st_slope_type %}
      {% for v in ['upsloping','flat','downsloping'] %}
      <option value="{{ v }}" {% if slope==v %}selected{% endif %}>{{ v }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Num Major Vessels</label>
    <input type="number" class="form-control" name="num_major_vessels" value="{{ baseline.num_major_vessels }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Thalassemia Type</label>
    <select class="form-select" name="thalassemia_type">
      {% set thal = baseline.thalassemia_type %}
      {% for v in ['normal','fixed_defect','reversible_defect'] %}
      <option value="{{ v }}" {% if thal==v %}selected{% endif %}>{{ v }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Variable</label>
    <select class="form-select" name="variable">
      <option value="age" {% if variable=='age' %}selected{% endif %}>Age</option>
      <option value="cholesterol" {% if variable=='cholesterol' %}selected{% endif %}>Cholesterol (mg/dL)</option>
      <option value="resting_blood_pressure" {% if variable=='resting_blood_pressure' %}selected{% endif %}>Resting Blood Pressure (systolic mmHg)</option>
      <option value="fasting_blood_sugar" {% if variable=='fasting_blood_sugar' %}selected{% endif %}>Fasting Blood Sugar / Glucose (mg/dL)</option>
      <option value="max_heart_rate_achieved" {% if variable=='max_heart_rate_achieved' %}selected{% endif %}>Max Heart Rate Achieved (bpm)</option>
    </select>
  </div>
  <div class="col-md-2 d-flex align-items-end">
    <button class="btn btn-brand w-100" type="submit">Run</button>
  </div>
</form>
{% if prediction %}
<div class="mb-4">
  <h2>Prediction Result</h2>
  <p><strong>{{ prediction.label }}</strong></p>
  {% if prediction.risk_pct is not none %}
  <div class="progress mb-2" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ prediction.risk_pct }}">
    <div class="progress-bar bg-info" style="width: {{ prediction.risk_pct }}%">{{ prediction.risk_pct }}%</div>
  </div>
  {% endif %}
  {% if prediction.confidence_pct is not none %}
  <p class="mb-0">Model confidence: {{ prediction.confidence_pct }}%</p>
  {% endif %}
</div>
{% endif %}
{% if results.exercise_angina %}
<div class="mb-5">
  <h2>Heart disease risk change with {{ results.exercise_angina.label }}</h2>
  <div id="exercise-angina-chart" style="height:350px;"></div>
</div>
{% endif %}
{% endblock %}
{% block scripts %}
  {{ super() }}
  {% if results.exercise_angina %}
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    var res = {{ results.exercise_angina|tojson }};
    var no = {x: res.no.map(r=>r.value), y: res.no.map(r=>r.risk_pct), mode:'lines', name:'No Angina', line:{color:'green'}};
    var yes = {x: res.yes.map(r=>r.value), y: res.yes.map(r=>r.risk_pct), mode:'lines', name:'Yes Angina', line:{color:'red'}};
    var cur = {x:[res.current.value], y:[res.current.risk_pct], mode:'markers+text', text:['You\'re here'], textposition:'top center', marker:{color:res.current.angina ? 'red':'green', size:8}, showlegend:false};
    Plotly.newPlot('exercise-angina-chart', [no, yes, cur], {xaxis:{title: res.label, range:[res.vmin, res.vmax]}, yaxis:{title:'Risk (%)', range:[0,100]}, margin:{t:30}});
  });
  </script>
  {% endif %}
{% endblock %}
