{% extends 'base.html' %}
{% block title %}Settings{% endblock %}
{% from '_components/avatar.html' import avatar %}
{% from '_components/modal_upload.html' import modal_upload %}
{% from '_components/form_field.html' import form_field %}
{% from '_components/password_group.html' import password_group %}
{% from '_components/toggle.html' import theme_toggle %}
{% from '_components/file_input.html' import file_input %}
{% from '_components/badges.html' import badge %}
{% from '_components/accordion.html' import log_accordion %}
{% from '_components/table_toolbar.html' import table_toolbar %}
{% block content %}
<nav class="sticky-md-top border-bottom py-2 mb-4 d-none d-md-block bg-transparent">
  <ul class="nav justify-content-center small">
    <li class="nav-item"><a class="nav-link" href="#account">Account</a></li>
    <li class="nav-item"><a class="nav-link" href="#security">Security</a></li>
    <li class="nav-item"><a class="nav-link" href="#customization">Customization</a></li>
    <li class="nav-item"><a class="nav-link" href="#activity-log">Activity Log</a></li>
  </ul>
</nav>
<div class="row g-4">
  <aside class="col-md-4">
    <div class="card text-center">
      <div class="card-body">
        {{ avatar(current_user.avatar_url or url_for('static', filename='avatars/None.jpg'), current_user.username) }}
        <p class="fw-semibold mt-3 mb-0">{{ current_user.username }}</p>
        <p class="text-muted small mb-0">{{ current_user.email }}</p>
        <p class="text-muted small">{{ current_user.nickname }}</p>
      </div>
    </div>
  </aside>
  <section class="col-md-8">
    <div id="account" class="mb-5">
      <div class="card mb-4">
        <div class="card-header"><h2 class="h6 mb-0">Account</h2></div>
        <form method="post" action="{{ url_for('settings.update_profile') }}" class="card-body p-4 position-relative">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          {{ form_field('text', 'username', 'Username', current_user.username, help='Visible to others.') }}
          {{ form_field('email', 'email', 'Email', current_user.email) }}
          {{ form_field('text', 'nickname', 'Nickname', current_user.nickname) }}
          <div class="card-footer bg-body border-0 position-sticky bottom-0 d-flex justify-content-end gap-2">
            <button type="reset" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn btn-brand">Save</button>
          </div>
        </form>
      </div>
      <div class="card mb-4">
        <div class="card-header"><h2 class="h6 mb-0">Password</h2></div>
        <form method="post" action="{{ url_for('settings.update_password') }}" class="card-body p-4">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          {{ password_group() }}
          <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="reset" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn btn-brand">Save</button>
          </div>
        </form>
      </div>
      <div class="card" id="theme-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h6 mb-0">Theme</h2>
          <span class="badge bg-info text-dark">Preview</span>
        </div>
        <div class="card-body p-4">
          {{ theme_toggle('theme-preview-toggle') }}
          <div class="form-text">Changes here are illustrative and not saved.</div>
        </div>
      </div>
    </div>
    <div id="security" class="mb-5">
      <div class="card">
        <div class="card-header"><h2 class="h6 mb-0">Two-Step Verification</h2></div>
        <div class="card-body p-4">
          {% if current_user.mfa_enabled %}
            {{ badge('Enabled', 'success') }}
            <p class="mt-2 mb-3 small">Two-step verification is enabled.</p>
            <a class="btn btn-danger me-2" href="{{ url_for('auth.mfa_disable') }}">Disable</a>
            <form method="post" action="{{ url_for('auth.mfa_regenerate_codes') }}" class="d-inline">
              <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-secondary" type="submit">Regenerate Codes</button>
            </form>
          {% else %}
            {{ badge('Available', 'info') }}
            <p class="mt-2 mb-3 small">Add a second layer of security to your account.</p>
            <a class="btn btn-brand" href="{{ url_for('auth.mfa_setup') }}">Enable</a>
          {% endif %}
        </div>
      </div>
    </div>
    {% if current_user.role == 'SuperAdmin' %}
    <div id="customization" class="mb-5">
      <div class="card">
        <div class="card-header"><h2 class="h6 mb-0">App Branding</h2></div>
        <form method="post" action="{{ url_for('settings.update_branding') }}" enctype="multipart/form-data" class="card-body p-4">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          {{ form_field('text', 'app_name', 'App Name', app_name) }}
          {{ file_input('logo', 'Upload Logo') }}
          <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="reset" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn btn-brand">Save</button>
          </div>
        </form>
      </div>
    </div>
    {% endif %}
    <div id="activity-log" class="mb-5">
      <div class="card">
        <div class="card-header"><h2 class="h6 mb-0">Activity Log</h2></div>
        <div class="card-body p-4">
          {{ table_toolbar() }}
          {{ log_accordion(logs) }}
          <nav aria-label="Activity pagination" class="mt-3">
            <ul class="pagination pagination-sm justify-content-end">
              <li class="page-item disabled"><a class="page-link" href="#" tabindex="-1">Previous</a></li>
              <li class="page-item active"><a class="page-link" href="#">1</a></li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">Next</a></li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </section>
</div>
<footer class="text-center text-muted small mt-5">Â© 2025 HeartLytics. For educational use only.</footer>

{{ modal_upload('avatarModal', 'Upload Avatar', url_for('settings.update_profile'), 'avatar') }}
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/settings-ui.js') }}"></script>
{% endblock %}
