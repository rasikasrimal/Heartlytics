{% extends 'base.html' %}
{% block title %}Settings{% endblock %}
{% import '_components/form.html' as form %}
{% import '_components/buttons.html' as btn %}
{% import '_components/avatar.html' as av %}
{% import '_components/badges.html' as badge %}
{% import '_components/activity_item.html' as activity %}
{% import '_components/modal_upload.html' as modal %}
{% block content %}
<h1 class="mb-4">Settings</h1>
<div class="row g-4">
  <div class="col-md-4">
    <div class="card shadow-sm text-center p-4">
      {{ av.avatar(url_for('static', filename='avatars/' + (current_user.avatar or 'default.png')), current_user.username, 180) }}
      <h5 class="mt-3">{{ current_user.username }}</h5>
      {% if current_user.nickname %}<p class="text-muted small mb-1">{{ current_user.nickname }}</p>{% endif %}
      <div class="mt-2">
        {% if current_user.mfa_enabled %}
          {{ badge.badge('MFA On','success') }}
        {% else %}
          {{ badge.badge('MFA Off','secondary') }}
        {% endif %}
        <a href="{{ url_for('auth.mfa_setup') }}" class="ms-2 small">Manage</a>
      </div>
    </div>
  </div>
  <div class="col-md-8">
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <form id="profile-form" method="post" action="{{ url_for('settings.update_profile') }}" enctype="multipart/form-data">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          {{ form.text_input('username', 'Display Name', value=current_user.username) }}
          {{ form.text_input('email', 'Email', type='email', value=current_user.email, attrs={'readonly':'readonly'}) }}
          <div class="mb-3">
            <button type="button" class="btn btn-link p-0" data-bs-toggle="modal" data-bs-target="#passwordModal">Change password</button>
          </div>
          <div class="d-flex gap-2">
            {{ btn.primary('Save changes', {'id':'profile-save','disabled':'disabled'}) }}
            {{ btn.secondary('Cancel', {'type':'reset'}) }}
          </div>
        </form>
      </div>
    </div>
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Activity Log</span>
        <div class="d-flex gap-2">
          <label for="log-search" class="visually-hidden">Search activity</label>
          <input id="log-search" type="search" class="form-control form-control-sm" placeholder="Search">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary btn-sm">All</button>
            <button type="button" class="btn btn-outline-secondary btn-sm">Login</button>
            <button type="button" class="btn btn-outline-secondary btn-sm">Settings</button>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="accordion accordion-flush" id="activity-accordion">
          {% for log in logs %}
            {{ activity.activity_item(log, loop.index) }}
          {% else %}
            <div class="p-3 text-muted small">No activity</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{{ modal.modal_upload('avatarModal','Change Photo') }}
<div class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('settings.update_password') }}">
      <div class="modal-header">
        <h5 class="modal-title">Change Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
        {{ form.text_input('current_password','Current Password', type='password', attrs={'autocomplete':'off'}) }}
        {{ form.text_input('new_password','New Password', type='password', attrs={'id':'new_password','autocomplete':'new-password'}) }}
        {{ form.text_input('confirm_password','Confirm New Password', type='password', attrs={'id':'confirm_password','autocomplete':'new-password'}) }}
        <div id="password-match" class="small mt-2"></div>
      </div>
      <div class="modal-footer">
        {{ btn.secondary('Cancel', {'data-bs-dismiss':'modal'}) }}
        {{ btn.primary('Update Password', {'id':'password-submit','disabled':'disabled'}) }}
      </div>
    </form>
  </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const form = document.getElementById('profile-form');
  const saveBtn = document.getElementById('profile-save');
  if(form){
    form.addEventListener('input', () => saveBtn.disabled = false);
  }
  const np = document.getElementById('new_password');
  const cp = document.getElementById('confirm_password');
  const msg = document.getElementById('password-match');
  const btn = document.getElementById('password-submit');
  function check(){
    if(!np.value || !cp.value){
      msg.textContent = '';
      btn.disabled = true;
      return;
    }
    if(np.value === cp.value){
      msg.textContent = '✅ passwords match';
      msg.classList.remove('text-danger');
      msg.classList.add('text-success');
      btn.disabled = false;
    } else {
      msg.textContent = '❌ passwords don\u2019t match';
      msg.classList.remove('text-success');
      msg.classList.add('text-danger');
      btn.disabled = true;
    }
  }
  np.addEventListener('input', check);
  cp.addEventListener('input', check);
});
</script>
{% endblock %}
