{% extends 'base.html' %}
{% block title %}Settings{% endblock %}
{% from '_components/avatar.html' import avatar %}
{% from '_components/modal_upload.html' import modal_upload %}
{% from '_components/form_field.html' import form_field %}
{% from '_components/password_group.html' import password_group %}
{% from '_components/file_input.html' import file_input %}
{% from '_components/badges.html' import badge %}
{% from '_components/accordion.html' import log_accordion %}
{% from '_components/table_toolbar.html' import table_toolbar %}
{% block content %}
<div class="settings-page">
<nav id="settingsNav" class="sticky-top border-bottom py-2 mb-3 d-none d-md-block navbar bg-body" style="top:56px; z-index:1020;">
  <ul class="nav justify-content-center small w-100">
    <li class="nav-item"><a class="nav-link" href="#account">Account</a></li>
    <li class="nav-item"><a class="nav-link" href="#security">Security</a></li>
    <li class="nav-item"><a class="nav-link" href="#customization">Customization</a></li>
  </ul>
</nav>
<div class="row g-3">
  <aside class="col-md-4">
    <div class="card text-center">
      <div class="card-body">
        {{ avatar(url_for('static', filename='avatars/' ~ (current_user.avatar or 'None.jpg')), current_user.username) }}
        <p class="fw-semibold mt-3 mb-0">{{ current_user.username }}</p>
        <p class="text-muted small mb-0">{{ current_user.email }}</p>
        <p class="text-muted small">{{ current_user.nickname or '' }}</p>
      </div>
    </div>
  </aside>
  <section class="col-md-8">
    <div id="account" class="mb-3" style="scroll-margin-top:100px;">
      <div class="card mb-3">
        <div class="card-header"><h2 class="h6 mb-0">Account</h2></div>
        <form method="post" action="{{ url_for('settings.update_profile') }}" class="card-body position-relative">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          {{ form_field('text', 'username', 'Username', current_user.username, help='Visible to others.') }}
          {% if username_cooldown_active %}
          <div class="text-muted small mt-n2 mb-2">
            Next change available on: <strong>{{ username_next_change_at.strftime('%Y-%m-%d') }}</strong>
          </div>
          {% endif %}
          <div class="text-muted small mb-2">
            For your security, old usernames are held for {{ username_hold_days }} days to prevent impersonation.
          </div>
          {{ form_field('email', 'email', 'Email', current_user.email) }}
          {{ form_field('text', 'nickname', 'Nickname', current_user.nickname) }}
          <div class="card-footer bg-transparent border-0 position-sticky bottom-0 d-flex justify-content-end gap-2">
            <button type="reset" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn btn-brand">Save</button>
          </div>
        </form>
      </div>
      <div class="card mb-3">
        <div class="card-header"><h2 class="h6 mb-0">Password</h2></div>
        <form method="post" action="{{ url_for('settings.update_password') }}" class="card-body">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          {{ password_group() }}
          <div class="d-flex justify-content-end gap-2 mt-2">
            <button type="reset" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn btn-brand">Save</button>
          </div>
        </form>
      </div>
    </div>
    <div id="security" class="mb-3" style="scroll-margin-top:100px;">
      <div class="card">
        <div class="card-header"><h2 class="h6 mb-0">Two-Step Verification</h2></div>
        <div class="card-body">
          {% if current_user.mfa_enabled %}
            {{ badge('Enabled', 'success') }}
            <p class="mt-2 mb-3 small">Two-step verification is enabled.</p>
            <a class="btn btn-danger me-2" href="{{ url_for('auth.mfa_disable') }}">Disable</a>
            <form method="post" action="{{ url_for('auth.mfa_regenerate_codes') }}" class="d-inline">
              <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-secondary" type="submit">Regenerate Codes</button>
            </form>
          {% else %}
            {{ badge('Available', 'info') }}
            <p class="mt-2 mb-3 small">Add a second layer of security to your account.</p>
            <a class="btn btn-brand" href="{{ url_for('auth.mfa_setup') }}">Enable</a>
          {% endif %}
        </div>
      </div>
    </div>
    {% if current_user.role == 'SuperAdmin' %}
    <div id="customization" class="mb-3" style="scroll-margin-top:100px;">
      <div class="card">
        <div class="card-header"><h2 class="h6 mb-0">App Branding</h2></div>
        <form method="post" action="{{ url_for('settings.update_branding') }}" enctype="multipart/form-data" class="card-body">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          {{ form_field('text', 'app_name', 'App Name', app_name) }}
          {{ file_input('logo', 'Upload Logo') }}
          <div class="d-flex justify-content-end gap-2 mt-2">
            <button type="reset" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn btn-brand">Save</button>
          </div>
        </form>
      </div>
    </div>
    {% endif %}
    {# Activity Log moved to SuperAdmin > Audit Logs #}
  </section>
 </div>
</div>
<footer class="text-center text-muted small mt-5">© 2025 HeartLytics. For educational use only.</footer>

{{ modal_upload('avatarModal', 'Upload Avatar', url_for('settings.update_profile'), 'avatar') }}
<!-- Username cooldown modal -->
<div class="modal fade" id="usernameCooldownModal" tabindex="-1" aria-labelledby="usernameCooldownModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="usernameCooldownModalLabel">Username Change Cooldown</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        You can change your username again on <strong id="cooldown-date">—</strong>.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/settings-ui.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const until = {{ ('"' ~ username_cooldown_until ~ '"') if username_cooldown_until else 'null' }};
    if (until) {
      try {
        const dt = new Date(until);
        const el = document.getElementById('cooldown-date');
        if (el) {
          const y = dt.getFullYear();
          const m = String(dt.getMonth()+1).padStart(2,'0');
          const d = String(dt.getDate()).padStart(2,'0');
          el.textContent = `${y}-${m}-${d}`;
        }
        const modal = new bootstrap.Modal(document.getElementById('usernameCooldownModal'));
        modal.show();
      } catch (e) { /* noop */ }
    }
  });
</script>
{% endblock %}
