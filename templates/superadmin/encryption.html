{% extends 'base.html' %}
{% block title %}Encryption Demo{% endblock %}
{% block content %}
<ul class="nav nav-tabs mb-4">
  <li class="nav-item"><a class="nav-link" href="{{ url_for('superadmin.dashboard') }}">Users</a></li>
  <li class="nav-item"><a class="nav-link" href="{{ url_for('superadmin.audit_logs') }}">Audit Logs</a></li>
  <li class="nav-item"><a class="nav-link active" href="{{ url_for('superadmin.encryption_index') }}">Encryption</a></li>
 </ul>

<div class="alert alert-warning d-flex align-items-start" role="alert">
  <i class="bi bi-shield-lock me-2 fs-5"></i>
  <div>
    <strong>SuperAdmin only:</strong> This page shows encrypted patient data for demonstration. Master keys are never shown. Decryption runs server‑side only if a dev master key is configured.
  </div>
  </div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form class="row g-3" method="get" action="{{ url_for('superadmin.encryption_index') }}">
      <div class="col-md-4">
        <label class="form-label">Find Patient by ID</label>
        <input type="number" class="form-control" name="id" placeholder="e.g. 42" value="{{ request.args.get('id','') }}">
      </div>
      <div class="col-md-2 align-self-end">
        <button type="submit" class="btn btn-primary w-100">Open</button>
      </div>
    </form>
  </div>
</div>

{% if recent and not patient %}
<div class="card shadow-sm mb-4">
  <div class="card-header">Recent Patients</div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead><tr><th>ID</th><th>Entered By</th><th>Created</th><th></th></tr></thead>
        <tbody>
          {% for r in recent %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.entered_by.username if r.entered_by else '—' }}</td>
            <td>{{ r.created_at.strftime('%Y-%m-%d %H:%M') if r.created_at else '' }}</td>
            <td class="text-end"><a class="btn btn-sm btn-outline-primary" href="{{ url_for('superadmin.encryption_view', pid=r.id) }}">View</a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{% if patient or prediction %}
<div class="card shadow-sm mb-4">
  <div class="card-header d-flex align-items-center justify-content-between">
    <div>
      {% set subj = subject or ('patient' if patient else 'prediction') %}
      <h2 class="h6 mb-0">{{ 'Patient' if subj=='patient' else 'Prediction' }} Record #{{ (patient.id if subj=='patient' else prediction.id) }}</h2>
      {% if subj=='patient' %}
      <div class="text-muted small">Entered by: {{ patient.entered_by.username if patient.entered_by else '—' }}</div>
      {% endif %}
    </div>
    <div>
      {% if can_decrypt %}
      <form method="post" action="{{ decrypt_action }}" class="d-inline">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-sm btn-success">Decrypt Locally</button>
      </form>
      {% else %}
      <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="DEV_KMS_MASTER_KEY not configured">Decrypt Locally</button>
      {% endif %}
    </div>
  </div>
  <div class="card-body">
    {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">Envelope Components</div>
          <div class="card-body small">
            {% if blob %}
            <div class="mb-2"><span class="text-muted">Key ID:</span> {{ blob.kid or '—' }}</div>
            <div class="mb-2"><span class="text-muted">Key Version:</span> {{ blob.kver or '—' }}</div>
            <div class="mb-2">
              <div class="d-flex align-items-center justify-content-between"><span class="text-muted">Ciphertext (Base64)</span><button class="btn btn-sm btn-outline-secondary" data-copy="#ct">Copy</button></div>
              <textarea id="ct" class="form-control" rows="3" readonly>{{ blob.ciphertext }}</textarea>
            </div>
            <div class="mb-2">
              <div class="d-flex align-items-center justify-content-between"><span class="text-muted">Nonce (Base64)</span><button class="btn btn-sm btn-outline-secondary" data-copy="#nonce">Copy</button></div>
              <input id="nonce" class="form-control" readonly value="{{ blob.nonce }}">
            </div>
            <div class="mb-2">
              <div class="d-flex align-items-center justify-content-between"><span class="text-muted">Tag (Base64)</span><button class="btn btn-sm btn-outline-secondary" data-copy="#tag">Copy</button></div>
              <input id="tag" class="form-control" readonly value="{{ blob.tag }}">
            </div>
            <div class="mb-2">
              <div class="d-flex align-items-center justify-content-between"><span class="text-muted">Wrapped DEK (Base64)</span><button class="btn btn-sm btn-outline-secondary" data-copy="#wdk">Copy</button></div>
              <textarea id="wdk" class="form-control" rows="2" readonly>{{ blob.wrapped_dk }}</textarea>
            </div>
            {% else %}
            <div class="text-muted">No encrypted data stored for this record.</div>
            {% if subject=='prediction' %}
            <hr>
            <form method="post" action="{{ url_for('superadmin.encryption_set_name_pred', pred_id=prediction.id) }}" class="row g-2 align-items-end">
              <div class="col-8">
                <label class="form-label small mb-1">Set Patient Name (will be encrypted if enabled)</label>
                <input type="text" name="patient_name" class="form-control form-control-sm" maxlength="120" placeholder="e.g., Jane Doe">
              </div>
              <div class="col-4">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-primary w-100">Save & Encrypt</button>
              </div>
            </form>
            {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">{{ decrypted_header }}</div>
          <div class="card-body">
            {% if decrypted %}
            <pre class="small mb-0" style="white-space:pre-wrap">{{ decrypted }}</pre>
            {% else %}
            <div class="text-muted small">Click "Decrypt Locally" to attempt decrypt on the server. Keys are never shown.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="card shadow-sm">
  <div class="card-header">How it works</div>
  <div class="card-body">
    <ol class="small mb-0">
      <li>App generates a random data key (DEK) and encrypts JSON with AES‑GCM.</li>
      <li>DEK is wrapped with a master key (dev or KMS) and stored alongside ciphertext.</li>
      <li>Decryption unwraps the DEK and verifies context before returning plaintext.</li>
    </ol>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el=>new bootstrap.Tooltip(el));
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-copy]');
    if (!btn) return;
    const sel = btn.getAttribute('data-copy');
    const el = document.querySelector(sel);
    if (!el) return;
    el.select && el.select();
    navigator.clipboard.writeText(el.value || el.textContent || '');
    btn.textContent = 'Copied';
    setTimeout(()=>btn.textContent='Copy', 1200);
  });
</script>
{% endblock %}
