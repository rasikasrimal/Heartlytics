{% extends "base.html" %}
{% block title %}Dashboard | Heart Disease Risk{% endblock %}
{% block head %}
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" defer></script>
{% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h4 mb-0">Model Dashboard</h1>
  <div class="d-flex gap-2">
    <a href="{{ url_for('outlier_handling') }}" class="btn btn-outline-secondary btn-transition">Outlier Handling</a>
    <button id="btn-download-csv" class="btn btn-outline-secondary btn-transition">Download CSV</button>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-transition">Back to form</a>
    <button id="btn-download-pdf" class="btn btn-brand btn-transition">Generate PDF</button>
  </div>
</div>

<!-- KPI cards -->
<div class="row g-3 mb-3">
  <div class="col-12 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex align-items-center">
        <div class="me-3 text-brand fs-1"><i class="bi bi-activity"></i></div>
        <div>
          <div class="text-muted small">Total Predictions</div>
          <div class="fs-3 fw-bold" id="kpi-total">—</div>
          <div class="small text-muted" id="kpi-date-range">—</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex align-items-center">
        <div class="me-3 text-brand fs-1"><i class="bi bi-heart-pulse-fill"></i></div>
        <div>
          <div class="text-muted small">Positive Rate</div>
          <div class="fs-3 fw-bold"><span id="kpi-pos-rate">—</span>%</div>
          <div class="small text-muted">Based on predicted label</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex align-items-center">
        <div class="me-3 text-brand fs-1"><i class="bi bi-graph-up"></i></div>
        <div>
          <div class="text-muted small">Avg Risk Probability</div>
          <div class="fs-3 fw-bold"><span id="kpi-avg-risk">—</span>%</div>
          <div class="small text-muted">Reconstructed from label + confidence</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex align-items-center">
        <div class="me-3 text-brand fs-1"><i class="bi bi-people-fill"></i></div>
        <div>
          <div class="text-muted small">Patients at Risk</div>
          <div class="fs-3 fw-bold" id="kpi-at-risk">—</div>
          <div class="small text-muted">Based on predicted label</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Charts -->
<div class="row g-3">
  <div class="col-12">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 mb-0">Risk probability distribution</h2>
          <div class="d-flex align-items-center gap-2">
            <div class="form-check form-switch mb-0">
              <input class="form-check-input" type="checkbox" id="toggle-hist">
              <label class="form-check-label small" for="toggle-hist">Histogram</label>
            </div>
            <button class="btn btn-sm btn-outline-secondary" data-view="#risk-hist" data-title="Risk probability distribution">View</button>
          </div>
        </div>
        <div id="risk-hist" class="chart-md"></div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 mb-0">Box plots: age & cholesterol by label</h2>
          <button class="btn btn-sm btn-outline-secondary" data-view="#boxplots" data-title="Box plots: age & cholesterol by label">View</button>
        </div>
        <div id="boxplots" class="chart-sm"></div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 mb-0">Correlation heatmap (numeric features)</h2>
          <button class="btn btn-sm btn-outline-secondary" data-view="#corr-heatmap" data-title="Correlation heatmap">View</button>
        </div>
        <div id="corr-heatmap" class="chart-sm"></div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 mb-0">Confusion matrix</h2>
          <button class="btn btn-sm btn-outline-secondary" data-view="#conf-matrix" data-title="Confusion matrix">View</button>
        </div>
        <div id="conf-matrix" class="chart-sm"></div>
      </div>
    </div>
  </div>
</div>

<!-- Clustering Insights -->
<div class="row g-3 mt-3">
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 mb-0">Cluster distribution</h2>
          <button class="btn btn-sm btn-outline-secondary" data-view="#cluster-dist" data-title="Cluster distribution">View</button>
        </div>
        <div id="cluster-dist" class="chart-sm"></div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 mb-0">Cluster profiles</h2>
          <button class="btn btn-sm btn-outline-secondary" data-view="#cluster-profile" data-title="Cluster profiles">View</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-striped" id="cluster-profile">
            <thead>
              <tr>
                <th>Cluster</th>
                <th>Centroid Age</th>
                <th>Centroid Chol</th>
                <th>Centroid Risk %</th>
                <th>Common Chest Pain</th>
                <th>Common Thal</th>
              </tr>
            </thead>
            <tbody id="cluster-profile-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cluster scatter plot -->
<div class="row g-3 mt-3">
  <div class="col-12">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 mb-0">Cluster scatter</h2>
          <button class="btn btn-sm btn-outline-secondary" data-view="#cluster-scatter" data-title="Cluster scatter">View</button>
        </div>
        <div class="d-flex flex-wrap align-items-end gap-2 mb-2">
          <div>
            <label class="form-label small mb-1" for="cluster-k">Clusters (k)</label>
            <select id="cluster-k" class="form-select form-select-sm">
              <option value="2">2</option>
              <option value="3" selected>3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>
          </div>
          <div>
            <label class="form-label small mb-1" for="cluster-x">X axis</label>
            <select id="cluster-x" class="form-select form-select-sm"></select>
          </div>
          <div>
            <label class="form-label small mb-1" for="cluster-y">Y axis</label>
            <select id="cluster-y" class="form-select form-select-sm"></select>
          </div>
        </div>
        <div id="cluster-msg" class="text-danger small mb-2"></div>
        <div id="cluster-scatter" class="chart-lg"></div>
      </div>
    </div>
  </div>
</div>
<!-- Recent table -->
<div class="card shadow-sm mt-3 card-hover">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
      <h2 class="h6 mb-0">Patient Records <span class="badge bg-secondary ms-1" id="record-count">0</span></h2>
      <div class="d-flex gap-2 ms-auto">
        <button id="btn-delete-all" class="btn btn-sm btn-outline-danger btn-transition">Delete all</button>
        <button id="btn-load-more" class="btn btn-sm btn-brand btn-transition">Load more</button>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-sm table-striped table-hover align-middle" id="recent-table">
        <thead class="table-light">
          <tr>
            <th class="filterable" data-key="id" data-col="id">ID<span class="ms-1 sort-indicator"></span></th>
            <th class="filterable" data-key="age" data-col="age">Age<span class="ms-1 sort-indicator"></span></th>
            <th class="filterable" data-key="sex_label" data-col="sex_label">Sex<span class="ms-1 sort-indicator"></span></th>
            <th class="filterable" data-key="chest_pain_label" data-col="chest_pain_label">Chest pain<span class="ms-1 sort-indicator"></span></th>
            <th class="filterable" data-key="cluster_id" data-col="cluster_id">Cluster<span class="ms-1 sort-indicator"></span></th>
            <th class="filterable" data-key="pred_label" data-col="pred_label">Pred<span class="ms-1 sort-indicator"></span></th>
            <th class="filterable" data-key="risk_pct" data-col="risk_pct">Risk %<span class="ms-1 sort-indicator"></span></th>
            <th data-col="actions"></th>
          </tr>
        </thead>
        <tbody id="recent-body">
          <!-- filled by JS -->
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- Modal for record details -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Record details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="detail-body"></div>
    </div>
  </div>
</div>

<!-- Modal for viewing charts -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewTitle">View</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body"></div>
    </div>
  </div>
</div>
<!-- Confirm delete modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><span class="text-danger me-2">⚠️</span>Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="confirmMsg">Are you sure?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light btn-transition" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger btn-transition" id="confirmDelete">Delete</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Wait until everything (incl. deferred Plotly) is ready
  window.addEventListener('load', async function () {
    // ---- Data from server ----
    const raw = {{ data|tojson }};
    let clusterInfo = {{ clusters|tojson }};
    const csrfToken = {{ csrf_token()|tojson }};
    const confirmModalEl = document.getElementById('confirmModal');
    const confirmMsg = document.getElementById('confirmMsg');
    const confirmDelete = document.getElementById('confirmDelete');
    let confirmAction = null;
    confirmDelete.addEventListener('click', async () => {
      if(!confirmAction) return;
      confirmDelete.disabled = true;
      const oldHtml = confirmDelete.innerHTML;
      confirmDelete.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Deleting…';
      try { await confirmAction(); }
      finally {
        confirmDelete.disabled = false;
        confirmDelete.innerHTML = oldHtml;
        hideModal(confirmModalEl);
        confirmAction = null;
      }
    });

    // ---- Helpers ----
    const sexMap = {0: "Female", 1: "Male"};
    const featureLabels = {
      age:'Age', resting_blood_pressure:'Rest BP', cholesterol:'Cholesterol',
      max_heart_rate_achieved:'Max HR', st_depression:'ST Depression',
      num_major_vessels:'# Vessels', risk_pct:'Risk %'
    };
    const allFeatures = ['age','resting_blood_pressure','cholesterol','max_heart_rate_achieved','st_depression','num_major_vessels','risk_pct'];
    function computeClusterColors(info){
      if (!info.length) return {};
      const base = ['#f97316','#3b82f6','#9333ea','#eab308'];
      const sorted = info.slice().sort((a,b)=>a.avg_risk_pct - b.avg_risk_pct);
      const colors = {};
      sorted.forEach((c,i)=>{
        if(i===0) colors[c.cluster_id]='#22c55e';
        else if(i===sorted.length-1) colors[c.cluster_id]='#dc2626';
        else colors[c.cluster_id]=base[(i-1)%base.length];
      });
      return colors;
    }
    let clusterColors = computeClusterColors(clusterInfo);
    let xFeature = 'age';
    let yFeature = 'risk_pct';
    const kSelect = document.getElementById('cluster-k');
    const xSelect = document.getElementById('cluster-x');
    const ySelect = document.getElementById('cluster-y');
    const clusterMsg = document.getElementById('cluster-msg');
    let viewSrc = null;
    function toDate(s){ return new Date(s); }
    function fmtPct(x){ return (Math.round(x * 10) / 10).toFixed(1); }
    function riskFromLabelConfidence(pred, conf){ return pred === 1 ? conf : (1 - conf); }
    function hexToRgba(hex, alpha){
      const h = hex.replace('#','');
      const bigint = parseInt(h,16);
      const r = (bigint>>16)&255, g=(bigint>>8)&255, b=bigint&255;
      return `rgba(${r},${g},${b},${alpha})`;
    }
    function fmtDate(d){ return d ? d.toISOString().replace('T',' ').slice(0,16) + ' UTC' : '—'; }
    function riskBadge(p){
      if (p < 20) return `<span class="badge bg-success">${fmtPct(p)}%</span>`;
      if (p < 50) return `<span class="badge bg-warning text-dark">${fmtPct(p)}%</span>`;
      return `<span class="badge bg-danger">${fmtPct(p)}%</span>`;
    }

    function showModal(modalEl){
      if(window.bootstrap && bootstrap.Modal){
        new bootstrap.Modal(modalEl).show();
      } else {
        modalEl.style.display = 'block';
      }
    }
    function hideModal(modalEl){
      if(window.bootstrap && bootstrap.Modal){
        const inst = bootstrap.Modal.getInstance(modalEl);
        if(inst) inst.hide();
      } else {
        modalEl.style.display = 'none';
        modalEl.dispatchEvent(new Event('hidden.bs.modal'));
      }
    }
    document.querySelector('#detailModal .btn-close').addEventListener('click', ()=>hideModal(document.getElementById('detailModal')));


    // ---- Preprocess rows ----
    let rows = raw.map(r => {
      const risk = riskFromLabelConfidence(r.prediction, r.confidence) * 100;
      return {
        ...r,
        dt: toDate(r.created_at),
        sex_label: sexMap[r.sex] ?? r.sex,
        chest_pain_label: (r.chest_pain_type||'').replaceAll('_',' '),
        pred_label: r.prediction ? 'Yes' : 'No',
        risk_pct: risk
      };
    }).sort((a,b) => a.dt - b.dt); // oldest -> newest
    // ---- State for pagination ----
    const PAGE_SIZE = 10;
    let shown = 0; // how many rows currently shown in the table
    const recordCountEl = document.getElementById('record-count');
    const filters = {}; // column -> {test:fn, text:string}
    let sortKey = 'dt';
    let sortAsc = false;
    let filterMenu = null;
    const toggleHist = document.getElementById('toggle-hist');

    async function parseJson(res){
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { throw new Error(text.slice(0,200)); }
    }
    function getSelectedFeatures(){
      return allFeatures;
    }
    function updateAxisOptions(){
      const opts = allFeatures.map(f=>`<option value="${f}">${featureLabels[f]||f}</option>`).join('');
      xSelect.innerHTML = opts;
      ySelect.innerHTML = opts;
      if(!allFeatures.includes(xFeature)) xFeature = allFeatures[0];
      if(!allFeatures.includes(yFeature) || yFeature === xFeature) yFeature = allFeatures.find(f=>f!==xFeature) || allFeatures[0];
      xSelect.value = xFeature;
      ySelect.value = yFeature;
    }
    async function runClustering(){
      const feats = getSelectedFeatures();
      clusterMsg.textContent = '';
      const k = kSelect.value;
      let resp, json;
      try {
        resp = await fetch(`/api/kmeans?features=${feats.join(',')}&k=${k}`);
        json = await parseJson(resp);
      } catch(e){
        clusterMsg.textContent = 'Clustering failed';
        return;
      }
      if(!resp.ok || json.error){
        clusterMsg.textContent = json.error || 'Clustering failed';
        return;
      }
      rows.forEach(r => { r.cluster_id = json.labels[r.id] ?? null; });
      clusterInfo = json.summaries;
      clusterColors = computeClusterColors(clusterInfo);
      renderClusterSection();
      renderTable(true);
      hideFilterMenu();
    }
    kSelect.addEventListener('change', runClustering);
    xSelect.addEventListener('change', ()=>{
      xFeature = xSelect.value;
      if(xFeature === yFeature){
        yFeature = allFeatures.find(f=>f!==xFeature) || xFeature;
        ySelect.value = yFeature;
      }
      renderClusterSection();
    });
    ySelect.addEventListener('change', ()=>{
      yFeature = ySelect.value;
      if(yFeature === xFeature){
        xFeature = allFeatures.find(f=>f!==yFeature) || yFeature;
        xSelect.value = xFeature;
      }
      renderClusterSection();
    });

    function getFilteredRows(){
      let data = rows.filter(r => {
        for (const key in filters){
          if(!filters[key].test(r[key])) return false;
        }
        return true;
      });
      data.sort((a,b)=>{
        const k = sortKey;
        let av = a[k], bv = b[k];
        if(k === 'dt'){ av = a.dt; bv = b.dt; }
        if(typeof av === 'number' && typeof bv === 'number'){
          return sortAsc ? av - bv : bv - av;
        }
        return sortAsc ? String(av).localeCompare(String(bv)) : String(bv).localeCompare(String(av));
      });
      return data;
    }

    function updateSortIndicators(){
      document.querySelectorAll('#recent-table th.filterable').forEach(th => {
        const span = th.querySelector('.sort-indicator');
        if(th.dataset.key === sortKey){
          span.innerHTML = sortAsc ? '&uarr;' : '&darr;';
        } else {
          span.innerHTML = '';
        }
      });
    }

    function updateColumnVisibility(){
      document.querySelectorAll('#recent-table [data-col]').forEach(el => {
        el.classList.remove('d-none');
      });
    }

    function hideFilterMenu(){
      if(filterMenu){
        filterMenu.remove();
        filterMenu = null;
      }
    }

    function showFilterMenu(th){
      const key = th.dataset.key;
      hideFilterMenu();
      const rect = th.getBoundingClientRect();
      filterMenu = document.createElement('div');
      filterMenu.className = 'filter-menu';
      const vals = [...new Set(rows.map(r => {
        if(key === 'pred_label') return r.pred_label;
        if(key === 'risk_pct') return fmtPct(r.risk_pct);
        return String(r[key]);
      }))].sort();
      const current = filters[key]?.text || '';
      filterMenu.innerHTML = `
        <select class="form-select form-select-sm mb-2">
          <option value="">(All)</option>
          ${vals.map(v => `<option value="${v}" ${v===current?'selected':''}>${v}</option>`).join('')}
        </select>

        <div class="btn-group btn-group-sm w-100 mb-2">
          <button class="btn btn-outline-secondary" data-sort="asc">Sort \u2191</button>
          <button class="btn btn-outline-secondary" data-sort="desc">Sort \u2193</button>
        </div>
        <div class="d-flex gap-1">
          <button class="btn btn-sm btn-brand flex-fill" data-action="apply">Apply</button>
          <button class="btn btn-sm btn-outline-secondary flex-fill" data-action="clear">Clear</button>
        </div>`;
      document.body.appendChild(filterMenu);
      filterMenu.style.left = rect.left + window.scrollX + 'px';
      filterMenu.style.top = rect.bottom + window.scrollY + 'px';
      const select = filterMenu.querySelector('select');
      select.focus();

      filterMenu.addEventListener('click', ev => {
        const btn = ev.target.closest('button');
        if(!btn) return;
        if(btn.dataset.sort){
          sortKey = key;
          sortAsc = btn.dataset.sort === 'asc';
          renderTable(true);
          hideFilterMenu();
        } else if(btn.dataset.action === 'apply'){
          const val = select.value;
          if(val){
            filters[key] = {
              text: val,
              test: v => key === 'risk_pct' ? fmtPct(v) === val : String(v) === val
            };
          } else {
            delete filters[key];
          }

          renderTable(true);
          hideFilterMenu();
        } else if(btn.dataset.action === 'clear'){
          delete filters[key];
          if(sortKey === key){ sortKey = 'dt'; sortAsc = false; }
          renderTable(true);
          hideFilterMenu();
        }
        ev.stopPropagation();
      });
    }

    // ---- KPI rendering ----
    function renderKPIs(){
      const total = rows.length;
      const posCount = rows.filter(r => r.prediction === 1).length;
      const negCount = total - posCount;
      const posRate = total ? (posCount / total) * 100 : 0;
      const avgRisk = total ? rows.reduce((s,r)=>s+r.risk_pct,0)/total : 0;
      const firstDt = total ? rows[0].dt : null;
      const lastDt  = total ? rows[rows.length-1].dt : null;

      document.getElementById('kpi-total').textContent = total || '0';
      document.getElementById('kpi-pos-rate').textContent = fmtPct(posRate);
      document.getElementById('kpi-avg-risk').textContent = fmtPct(avgRisk);
      document.getElementById('kpi-date-range').textContent = total ? `${fmtDate(firstDt)} → ${fmtDate(lastDt)}` : '—';
      document.getElementById('kpi-at-risk').textContent = posCount;
    }

    // ---- Charts rendering ----
    function renderCharts(){
      if (!rows.length) {
        ['risk-hist','boxplots','corr-heatmap','conf-matrix'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = '<div class="text-muted small">No data</div>';
        });
        return;
      }

      renderDistribution();

      // Box plots
      try {
        const neg = rows.filter(r=>r.prediction===0);
        const pos = rows.filter(r=>r.prediction===1);
        const traceAge0 = {y: neg.map(r=>r.age), name:'Age (No)', type:'box', boxpoints:false};
        const traceAge1 = {y: pos.map(r=>r.age), name:'Age (Yes)', type:'box', boxpoints:false};
        const traceCh0  = {y: neg.map(r=>r.cholesterol), name:'Chol (No)', type:'box', boxpoints:false};
        const traceCh1  = {y: pos.map(r=>r.cholesterol), name:'Chol (Yes)', type:'box', boxpoints:false};
        const layout = { grid:{rows:1, columns:2, pattern:'independent'}, margin:{l:40,r:10,t:10,b:20},
                         yaxis:{title:'Age'}, yaxis2:{title:'Cholesterol', anchor:'x2'}, xaxis:{title:''}, xaxis2:{title:'', domain:[0.52,1.0]} };
        traceAge0.xaxis='x1'; traceAge0.yaxis='y1'; traceAge1.xaxis='x1'; traceAge1.yaxis='y1';
        traceCh0.xaxis='x2'; traceCh0.yaxis='y2'; traceCh1.xaxis='x2'; traceCh1.yaxis='y2';
        if (window._boxInited) {
          Plotly.react('boxplots', [traceAge0, traceAge1, traceCh0, traceCh1], layout);
        } else {
          Plotly.newPlot('boxplots', [traceAge0, traceAge1, traceCh0, traceCh1], layout, {displayModeBar:false, responsive:true});
          window._boxInited = true;
        }
      } catch(e){ console.warn('Box plots:', e); }

      // Heatmap
      try {
        const cols = ['age','resting_blood_pressure','cholesterol','max_heart_rate_achieved','st_depression','num_major_vessels','sex','fasting_blood_sugar','exercise_induced_angina','prediction','risk_pct'];
        function corr(a,b){
          const n=a.length; if(!n) return 0;
          const ma=a.reduce((s,v)=>s+v,0)/n, mb=b.reduce((s,v)=>s+v,0)/n;
          let num=0, da=0, db=0; for(let i=0;i<n;i++){ const x=a[i]-ma, y=b[i]-mb; num+=x*y; da+=x*x; db+=y*y; }
          return num/(Math.sqrt(da*db)||1);
        }
        const mat = cols.map(c1 => {
          const v1 = rows.map(r => Number(r[c1]));
          return cols.map(c2 => corr(v1, rows.map(r=>Number(r[c2]))));
        });
        const labels = {
          age:'Age', resting_blood_pressure:'Rest BP', cholesterol:'Chol',
          max_heart_rate_achieved:'Max HR', st_depression:'ST dep', num_major_vessels:'# Vessels',
          sex:'Sex (0/1)', fasting_blood_sugar:'FBS (0/1)', exercise_induced_angina:'Ex angina (0/1)',
          prediction:'Pred (0/1)', risk_pct:'Risk %'
        };
        const trace = { z: mat, x: cols.map(c=>labels[c]||c), y: cols.map(c=>labels[c]||c),
                        type:'heatmap', colorscale:'RdBu', reversescale:true, zmin:-1, zmax:1,
                        hovertemplate: '%{y} vs %{x}<br>r = %{z:.2f}<extra></extra>' };
        const layout = { margin:{l:80,r:20,t:20,b:80}, height:320 };
        if (window._heatInited) {
          Plotly.react('corr-heatmap', [trace], layout);
        } else {
          Plotly.newPlot('corr-heatmap', [trace], layout, {displayModeBar:false, responsive:true});
          window._heatInited = true;
        }
      } catch(e){ console.warn('Heatmap:', e); }

      // Confusion matrix
      try {
        const yPred = rows.map(r => r.prediction);
        const yTrue = rows.map(r => r.actual !== undefined ? r.actual : r.prediction);
        let tn=0, fp=0, fn=0, tp=0;
        for(let i=0;i<yPred.length;i++){
          const yt=yTrue[i], yp=yPred[i];
          if(yt===0 && yp===0) tn++;
          else if(yt===0 && yp===1) fp++;
          else if(yt===1 && yp===0) fn++;
          else if(yt===1 && yp===1) tp++;
        }
        const z=[[tn,fp],[fn,tp]];
        const ann=[
          {x:0,y:0,text:String(tn),showarrow:false},
          {x:1,y:0,text:String(fp),showarrow:false},
          {x:0,y:1,text:String(fn),showarrow:false},
          {x:1,y:1,text:String(tp),showarrow:false}
        ];
        const trace={z,x:['Pred 0','Pred 1'],y:['Actual 0','Actual 1'],type:'heatmap',colorscale:'Blues',showscale:false,hovertemplate:'%{y} vs %{x}<br>%{z}<extra></extra>'};
        const layout={margin:{l:80,r:20,t:20,b:80},height:320,annotations:ann};
        if(window._cmInited){
          Plotly.react('conf-matrix',[trace],layout);
        }else{
          Plotly.newPlot('conf-matrix',[trace],layout,{displayModeBar:false,responsive:true});
          window._cmInited=true;
        }
      } catch(e){ console.warn('Confusion matrix:', e); }
    }

    function renderClusterSection(){
      if (!clusterInfo.length){
        const dist = document.getElementById('cluster-dist');
        if (dist) dist.innerHTML = '<div class="text-muted small">No data</div>';
        document.getElementById('cluster-profile-body').innerHTML = '<tr><td colspan="6" class="text-muted small">No data</td></tr>';
        const scatter = document.getElementById('cluster-scatter');
        if (scatter) scatter.innerHTML = '<div class="text-muted small">No data</div>';
        return;
      }
      const clusters = [...new Set(rows.map(r=>r.cluster_id))].filter(c=>c!==null && c!==undefined);
      try {
        const tracesDist = clusters.map(cid => {
          const vals = rows.filter(r=>r.cluster_id===cid).map(r=>r.risk_pct);
          if(!vals.length) return null;
          let sample = vals;
          if (sample.length > 2000){
            const step = Math.ceil(sample.length / 2000);
            sample = sample.filter((_,i)=>i%step===0);
          }
          const n = sample.length;
          const mean = sample.reduce((s,v)=>s+v,0)/n;
          const variance = sample.reduce((s,v)=>s+(v-mean)**2,0)/n;
          const sd = Math.sqrt(variance) || 1;
          const bw = 1.06 * sd * Math.pow(n,-1/5);
          const xs=[], ys=[];
          for(let x=0;x<=100;x+=1){
            let sum=0;
            for(const v of sample){
              const u=(x-v)/bw;
              sum+=Math.exp(-0.5*u*u);
            }
            ys.push(sum/(n*bw*Math.sqrt(2*Math.PI)));
            xs.push(x);
          }
          const color = clusterColors[cid] || '#888';
          return {x:xs, y:ys, type:'scatter', mode:'lines', line:{color,width:2}, fill:'tozeroy', fillcolor:hexToRgba(color,0.2), name:`Cluster ${cid}`};
        }).filter(Boolean);
        const layoutDist = {margin:{l:40,r:10,t:10,b:40}, xaxis:{title:'Risk %'}, yaxis:{title:'Density'}};
        Plotly.newPlot('cluster-dist', tracesDist, layoutDist, {displayModeBar:false, responsive:true});
      } catch(e){ console.warn('Cluster dist:', e); }
      try {
        const traces = clusters.map(cid => {
          const pts = rows.filter(r=>r.cluster_id===cid);
          return {
            x: pts.map(r=>r[xFeature]),
            y: pts.map(r=>r[yFeature]),
            mode:'markers',
            type:'scatter',
            name:`Cluster ${cid}`,
            marker:{color:clusterColors[cid]||undefined},
            text: pts.map(r=>`ID: ${r.id}`),
            hovertemplate:`%{text}<br>${featureLabels[xFeature]||xFeature}: %{x}<br>${featureLabels[yFeature]||yFeature}: %{y}<extra></extra>`
          };
        });
        const centroidTraces = clusterInfo.map(c => ({
          x:[c.centroid[xFeature]],
          y:[c.centroid[yFeature]],
          mode:'markers',
          type:'scatter',
          name:`Centroid ${c.cluster_id}`,
          marker:{color:clusterColors[c.cluster_id]||'#000', symbol:'x', size:12},
          hovertemplate:`Centroid ${c.cluster_id}<br>${featureLabels[xFeature]||xFeature}: %{x:.1f}<br>${featureLabels[yFeature]||yFeature}: %{y:.1f}<extra></extra>`
        }));
        const layout = {margin:{l:40,r:10,t:10,b:40}};
        Plotly.newPlot('cluster-scatter', traces.concat(centroidTraces), layout, {displayModeBar:false, responsive:true});
      } catch(e){ console.warn('Cluster scatter:', e); }
      const body = document.getElementById('cluster-profile-body');
      body.innerHTML = clusterInfo.map(c=>`
        <tr>
          <td>${c.cluster_id}</td>
          <td>${c.avg_age.toFixed(1)}</td>
          <td>${c.avg_cholesterol.toFixed(1)}</td>
          <td>${fmtPct(c.avg_risk_pct)}</td>
          <td class="text-capitalize">${(c.common_chest_pain_type||'').replaceAll('_',' ')}</td>
          <td class="text-capitalize">${(c.common_thalassemia_type||'').replaceAll('_',' ')}</td>
        </tr>
      `).join('');
    }

    function renderDistribution(){
      try {
        const vals = rows.map(r => r.risk_pct);
        let sample = vals;
        if (vals.length > 2000) {
          const step = Math.ceil(vals.length / 2000);
          sample = vals.filter((_, i) => i % step === 0);
        }
        const n = sample.length;
        const mean = sample.reduce((s,v)=>s+v,0)/n;
        const variance = sample.reduce((s,v)=>s+(v-mean)**2,0)/n;

        const sd = Math.sqrt(variance) || 1;
        const bandwidth = 1.06 * sd * Math.pow(n, -1/5);
        const xs = [], ys = [];
        for(let x=0; x<=100; x+=1){
          let sum = 0;
          for(const v of sample){

            const u = (x - v) / bandwidth;
            sum += Math.exp(-0.5 * u * u);
          }
          ys.push(sum / (n * bandwidth * Math.sqrt(2 * Math.PI)));
          xs.push(x);
        }
        const kde = {x: xs, y: ys, type:'scatter', mode:'lines', line:{color:'#dc2626', width:2},
                     fill:'tozeroy', fillcolor:'rgba(220,38,38,0.2)', name:'Density'};
        const hist = {x: vals, type:'histogram', nbinsx:20, marker:{color:'#dc2626'},
                      opacity:0.6, histnorm:'probability density', name:'Histogram'};
        const layout = {margin:{l:40,r:10,t:10,b:40}, xaxis:{title:'Risk %'}, yaxis:{title:'Density'}, bargap:0.05};
        const traces = toggleHist.checked ? [hist] : [kde];
        if (window._histInited) {
          Plotly.react('risk-hist', traces, layout);
        } else {
          Plotly.newPlot('risk-hist', traces, layout, {displayModeBar:false, responsive:true});
          window._histInited = true;
        }
      } catch(e){ console.warn('Risk distribution:', e); }
    }

    // ---- Table rendering with pagination ----
    const tbody = document.getElementById('recent-body');
    const btnLoad = document.getElementById('btn-load-more');
    const btnDeleteAll = document.getElementById('btn-delete-all');
    const btnDownloadPdf = document.getElementById('btn-download-pdf');
    const btnDownloadCsv = document.getElementById('btn-download-csv');

    function renderTable(reset=false){
      if (reset){ shown = 0; tbody.innerHTML = ''; }
      const data = getFilteredRows();
      const total = data.length;
      if (total === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-muted small">No data</td></tr>';
        btnLoad.disabled = true;
        btnLoad.textContent = 'No more';
        recordCountEl.textContent = '0';
        updateSortIndicators();
        updateColumnVisibility();
        return;
      }
      const page  = data.slice(shown, shown + PAGE_SIZE);

      const html = page.map(r => `
        <tr data-id="${r.id}">
          <td data-col="id">${r.id}</td>
          <td data-col="age">${r.age}</td>
          <td data-col="sex_label">${r.sex_label}</td>
          <td data-col="chest_pain_label" class="text-capitalize">${r.chest_pain_label}</td>
          <td data-col="cluster_id">${r.cluster_id ?? ''}</td>
          <td data-col="pred_label"><span class="badge ${r.prediction ? 'bg-danger' : 'bg-success'}">${r.prediction ? 'Yes' : 'No'}</span></td>
          <td data-col="risk_pct">${riskBadge(r.risk_pct)}</td>
          <td data-col="actions">
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary btn-view" data-id="${r.id}">View</button>
              <button class="btn btn-outline-danger btn-delete" data-id="${r.id}">Delete</button>
            </div>
          </td>
        </tr>
      `).join('');
      tbody.insertAdjacentHTML('beforeend', html);
      shown += page.length;

      if (shown >= total) {
        btnLoad.disabled = true;
        btnLoad.textContent = 'No more';
      } else {
        btnLoad.disabled = false;
        btnLoad.textContent = 'Load more';
      }
      recordCountEl.textContent = total;
      updateSortIndicators();
      updateColumnVisibility();
    }

    // Initial draw
    renderKPIs();
    renderCharts();
    updateAxisOptions();
    await runClustering();
    renderTable(true);
    // Load more
    btnLoad.addEventListener('click', function(){
      renderTable(false);
      hideFilterMenu();
    });
    toggleHist.addEventListener('change', renderDistribution);
    btnDownloadPdf.addEventListener('click', function(){
      window.open('/dashboard/pdf', '_blank');
    });
    btnDownloadCsv.addEventListener('click', function(){
      window.open('/dashboard/csv', '_blank');
    });
    btnDeleteAll.addEventListener('click', function(){
      if(!rows.length) return;
      const n = rows.length;
      confirmMsg.textContent = `Are you sure you want to delete all predictions? This action cannot be undone. ${n} record${n===1?'':'s'} will be deleted.`;
      confirmAction = async function(){
        btnDeleteAll.disabled = true;
        try {
          const res = await fetch('/api/predictions', {
            method:'DELETE',
            headers:{'X-CSRF-Token': csrfToken},
            credentials:'same-origin'
          });
          const data = await res.json();
          if(!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
          rows = [];
          renderKPIs();
          renderCharts();
          await runClustering();
          renderTable(true);
          hideFilterMenu();
        } catch(err) {
          alert('Could not delete: ' + err.message);
        } finally {
          btnDeleteAll.disabled = false;
        }
      };
      showModal(confirmModalEl);
    });

    document.addEventListener('click', function(e){
      const recTh = e.target.closest('#recent-table th.filterable');
      if(recTh){
        e.stopPropagation();
        showFilterMenu(recTh);
      } else if(filterMenu && !filterMenu.contains(e.target)){
        hideFilterMenu();
      }
    });

    // ---- Row deletion (uses DELETE /api/predictions/<id>, sends CSRF header) ----
    function attachDeleteHandler(container){
      container.addEventListener('click', async function(e){
        const btn = e.target.closest('.btn-delete');
        if (!btn) return;
        const id = Number(btn.dataset.id);
        if (!id) return;

        btn.disabled = true;
        const oldText = btn.textContent;
        btn.textContent = 'Deleting…';

        try {
          const res = await fetch(`/api/predictions/${id}`, {
            method: 'DELETE',
            headers: { 'X-CSRF-Token': csrfToken },
            credentials: 'same-origin'
          });

          const data = await parseJson(res);

          if (!res.ok || !data.ok) {
            throw new Error((data && data.error) ? data.error : `HTTP ${res.status}`);
          }

          rows = rows.filter(r => r.id !== id);
          renderKPIs();
          renderCharts();
          await runClustering();
          renderTable(true);
        } catch (err) {
          console.error(err);
          alert('Could not delete: ' + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = oldText;
        }
      });
    }

    attachDeleteHandler(tbody);

    function attachViewHandler(container){
      container.addEventListener('click', function(e){
        const btn = e.target.closest('.btn-view');
        if(!btn) return;
        const id = Number(btn.dataset.id);
        const rec = rows.find(r=>r.id===id);
        if(!rec) return;
        const outCols = (rec.outlier_cols||'').split(',').map(c=>c.trim());
        const tbodyHtml = Object.entries(rec).map(([k,v])=>{
          const cls = outCols.includes(k) ? ' class="table-danger"' : '';
          return `<tr${cls}><th class='text-end pe-2'>${k}</th><td>${v}</td></tr>`;
        }).join('');
        document.getElementById('detail-body').innerHTML = `<table class="table table-sm">${tbodyHtml}</table>`;
        showModal(document.getElementById('detailModal'));
      });
    }


    attachViewHandler(tbody);

    // View buttons for charts
    document.addEventListener('click', function(e){
      const btn = e.target.closest('[data-view]');
      if(!btn) return;
      const target = btn.dataset.view;
      const title = btn.dataset.title || 'View';
      const srcEl = document.querySelector(target);
      const modalEl = document.getElementById('viewModal');
      const dialog = modalEl.querySelector('.modal-dialog');
      const body = modalEl.querySelector('.modal-body');

      // reset dialog size each time
      dialog.className = 'modal-dialog modal-dialog-scrollable';
      if(srcEl && srcEl.id === 'cluster-profile'){
        dialog.classList.add('modal-fullscreen');
        const tableHtml = '<div class="table-responsive mb-4"><table class="table table-sm table-striped">' + srcEl.innerHTML + '</table></div>';
        const listHtml = '<ul class="small mb-0">' + clusterInfo.map(c=>{
          const chest = (c.common_chest_pain_type || 'N/A').replaceAll('_',' ');
          const thal = (c.common_thalassemia_type || 'N/A').replaceAll('_',' ');
          return `<li><strong>Cluster ${c.cluster_id}:</strong> avg age ${c.avg_age.toFixed(1)}, avg chol ${c.avg_cholesterol.toFixed(1)}, avg risk ${fmtPct(c.avg_risk_pct)}%, chest pain ${chest}, thal ${thal}</li>`;
        }).join('') + '</ul>';
        body.innerHTML = '<p class="mb-3 small">K-Means clustering groups similar patient records by iteratively updating cluster centroids (mean values for each feature). The table lists each centroid\'s age, cholesterol and risk percentage alongside the most common chest pain and thalassemia types.</p>' + tableHtml + '<h6 class="mt-2">Cluster descriptions</h6>' + listHtml;
      } else if(srcEl){
        dialog.classList.add('modal-lg');
        viewSrc = srcEl;
        srcEl.classList.add('d-none');
        if(window.Plotly && srcEl.data){
          body.innerHTML = '<div id="modal-chart"></div>';
          Plotly.newPlot('modal-chart', srcEl.data, srcEl.layout, {displayModeBar:false, responsive:true});
        } else {
          body.innerHTML = srcEl.innerHTML;
        }
      } else {
        dialog.classList.add('modal-lg');
        body.innerHTML = '<div class="text-muted">No data</div>';
      }
      document.getElementById('viewTitle').textContent = title;
      showModal(modalEl);
    });

    const viewModalEl = document.getElementById('viewModal');
    viewModalEl.addEventListener('hidden.bs.modal', function(){
      if(viewSrc){
        viewSrc.classList.remove('d-none');
        viewSrc = null;
      }
      this.querySelector('.modal-body').innerHTML = '';
    });
  });
</script>
{% endblock %}