{% extends 'base.html' %}
{% block title %}Export PDF{% endblock %}
{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css">
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js" defer></script>
<style>
  #preview-table th { cursor: pointer; }
  #preview-table td.id-risk { font-weight: 700; color: #dc2626; }
</style>
{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Generate PDF Report</h1>
  <button type="submit" form="pdfForm" class="btn btn-primary">
    <i class="bi bi-file-earmark-pdf-fill me-1"></i>Generate PDF
  </button>

</div>
<form method="post" id="pdfForm">
  <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" id="startDate" name="start_date">
  <input type="hidden" id="endDate" name="end_date">
  <input type="hidden" id="minPct" name="min_pct" value="0">
  <input type="hidden" id="maxPct" name="max_pct" value="100">
  <input type="hidden" id="columnsInput" name="columns">
  <div class="row g-3">
    <div class="col-lg-4">
      <div class="card mb-3"><div class="card-body">
        <label for="dateRange" class="form-label"><i class="bi bi-calendar-range me-1"></i>Date range</label>
        <input type="text" id="dateRange" class="form-control" placeholder="Select range">
      </div></div>
      <div class="card mb-3"><div class="card-body">
        <label class="form-label"><i class="bi bi-sliders me-1"></i>Risk probability range</label>
        <div id="pctRange"></div>
        <div class="small text-center mt-2" id="pctLabel">Selected Range: 0% – 100%</div>
      </div></div>
      <div class="card mb-3"><div class="card-body">
        <label class="form-label d-block"><i class="bi bi-person me-1"></i>Gender</label>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="genderMale" name="gender" value="Male" checked>
          <label class="form-check-label" for="genderMale"><i class="bi bi-gender-male me-1"></i>Male</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="genderFemale" name="gender" value="Female" checked>
          <label class="form-check-label" for="genderFemale"><i class="bi bi-gender-female me-1"></i>Female</label>

        </div>
      </div></div>
      <div class="card mb-3"><div class="card-body">
        <label class="form-label d-block"><i class="bi bi-heart-pulse me-1"></i>Heart disease risk</label>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="diseaseYes" name="disease" value="Yes" checked>
          <label class="form-check-label" for="diseaseYes"><i class="bi bi-check-circle-fill text-success me-1"></i>Yes</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="diseaseNo" name="disease" value="No" checked>
          <label class="form-check-label" for="diseaseNo"><i class="bi bi-x-circle-fill text-danger me-1"></i>No</label>
        </div>
      </div></div>
      <div class="card mb-3"><div class="card-body">
        <label class="form-label"><i class="bi bi-table me-1"></i>Columns</label>
        <div id="colChecks" class="ps-2"></div>
      </div></div>
      <div class="card mb-3"><div class="card-body">
        <label for="sortBy" class="form-label"><i class="bi bi-arrow-down-up me-1"></i>Sort by</label>
        <select id="sortBy" class="form-select w-auto">
          <option value="id">Patient ID</option>
          <option value="risk_pct">Risk %</option>
          <option value="age">Age</option>
        </select>
      </div></div>
      <div class="card mb-3"><div class="card-body">
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advFilters" aria-expanded="false" aria-controls="advFilters">SQL Editor</button>
        <div class="collapse mt-2" id="advFilters">
          <textarea class="form-control" id="customWhere" name="custom_where" rows="2" placeholder="e.g., age > 60 AND cholesterol > 250"></textarea>
          <div class="invalid-feedback">Invalid query</div>
          <div class="small text-muted mt-2">
            <strong>Columns:</strong>
            id, created_at, age, sex (0/1 or 'Male'/'Female'), chest_pain_type, resting_bp, cholesterol,
            fasting_blood_sugar, Restecg, max_heart_rate, exercise_induced_angina (0/1 or 'Yes'/'No'),
            oldpeak, st_slope_type, num_major_vessels, thalassemia_type, prediction (0/1 or 'Yes'/'No'), confidence (0–1)
            <br>
            <em>Examples:</em> sex = 1 AND age >= 70; sex = 'Male' AND age >= 70;
            chest_pain_type = 'asymptomatic';
            (CASE WHEN prediction=1 THEN confidence ELSE 1-confidence END) >= 0.7
          </div>
        </div>
      </div></div>
      <div class="card"><div class="card-body">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="resetFilters">Reset</button>
      </div></div>
    </div>
    <div class="col-lg-8">
      <div class="mb-3">
        <label for="notes" class="form-label">Doctor's notes</label>
        <textarea class="form-control" id="notes" name="doctor_notes" rows="3" placeholder="Optional"></textarea>
      </div>
      <div class="mb-2 d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Risk probability distribution (KDE)</h2>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-view="#risk-dist" data-title="Risk probability distribution">View</button>
      </div>
      <div id="risk-dist" class="chart-sm mb-5 overflow-hidden"></div>
      <div class="d-flex justify-content-between align-items-center mb-2 mt-4">

        <div>Records: <span id="recordCount"></span></div>
        <div id="pagination" class="d-flex gap-2">
          <button type="button" class="btn btn-sm btn-outline-secondary" id="prevPage">Previous</button>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="nextPage">Next</button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover" id="preview-table">
          <thead><tr></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</form>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
<script>
const records = {{ records|tojson }};
const minDate = "{{ min_date }}";
const maxDate = "{{ max_date }}";
const columnDefs = [
  {key:'id', label:'ID'},
  {key:'age', label:'Age'},
  {key:'sex', label:'Sex'},
  {key:'chest_pain', label:'Chest Pain'},
  {key:'rest_bp', label:'Rest BP'},
  {key:'cholesterol', label:'Chol'},
  {key:'max_hr', label:'Max HR'},
  {key:'pred_label', label:'Pred'},
  {key:'risk_pct', label:'Risk %'}
];
let visibleCols = new Set(columnDefs.map(c => c.key));
let currentRows = [];
let currentSort = {col:'id', dir:'asc'};
const pageSize = 20;
let currentPage = 1;
  
const startDate=document.getElementById('startDate');
const endDate=document.getElementById('endDate');
const dateRange=document.getElementById('dateRange');
const columnsInput=document.getElementById('columnsInput');
const pctSlider=document.getElementById('pctRange');
const pctLabel=document.getElementById('pctLabel');
const minPct=document.getElementById('minPct');
const maxPct=document.getElementById('maxPct');
const genderMale=document.getElementById('genderMale');
const genderFemale=document.getElementById('genderFemale');
const diseaseYes=document.getElementById('diseaseYes');
const diseaseNo=document.getElementById('diseaseNo');
const sortBy=document.getElementById('sortBy');
const customWhere=document.getElementById('customWhere');
const recordCount=document.getElementById('recordCount');
const resetBtn=document.getElementById('resetFilters');
const prevPage=document.getElementById('prevPage');
const nextPage=document.getElementById('nextPage');
  
function buildColumnCheckboxes(){
  const wrap=document.getElementById('colChecks');
  columnDefs.forEach(col=>{
    const div=document.createElement('div');
    div.className='form-check';
    div.innerHTML=`<input class="form-check-input" type="checkbox" id="col-${col.key}" checked data-col="${col.key}"><label class="form-check-label" for="col-${col.key}">${col.label}</label>`;
    wrap.appendChild(div);
  });
  wrap.querySelectorAll('input').forEach(cb=>{
    cb.addEventListener('change',()=>{
      if(cb.checked) visibleCols.add(cb.dataset.col); else visibleCols.delete(cb.dataset.col);
      columnsInput.value=Array.from(visibleCols).join(',');
      renderTable(currentRows);
      renderPagination();
      
    });
  });
  columnsInput.value=Array.from(visibleCols).join(',');
}
buildColumnCheckboxes();
const datePicker=flatpickr(dateRange,{mode:'range',dateFormat:'Y-m-d',defaultDate:[minDate,maxDate],onChange:function(selectedDates){if(selectedDates.length===2){startDate.value=selectedDates[0].toISOString().slice(0,10);endDate.value=selectedDates[1].toISOString().slice(0,10);}else{startDate.value='';endDate.value='';}update();}});
startDate.value=minDate;endDate.value=maxDate;
noUiSlider.create(pctSlider,{start:[0,100],connect:true,range:{min:0,max:100},step:1});
pctSlider.noUiSlider.on('update',(values)=>{const min=Math.round(values[0]);const max=Math.round(values[1]);pctLabel.textContent=`Selected Range: ${min}% – ${max}%`;minPct.value=min;maxPct.value=max;});
pctSlider.noUiSlider.on('change',update);
[genderMale,genderFemale,diseaseYes,diseaseNo,sortBy].forEach(el=>el.addEventListener('change',update));
customWhere.addEventListener('input',update);
resetBtn.addEventListener('click',()=>{datePicker.setDate([minDate,maxDate],true);pctSlider.noUiSlider.set([0,100]);genderMale.checked=genderFemale.checked=diseaseYes.checked=diseaseNo.checked=true;sortBy.value='id';customWhere.value='';customWhere.classList.remove('is-invalid');visibleCols=new Set(columnDefs.map(c=>c.key));document.querySelectorAll('#colChecks input').forEach(cb=>cb.checked=true);columnsInput.value=Array.from(visibleCols).join(',');update();});
function matchAdvanced(r){
  const clause = customWhere.value.trim();
  if (!clause) { customWhere.classList.remove('is-invalid'); return true; }
  try {
    let expr = clause
      .replace(/>=/g,'__GTE__')
      .replace(/<=/g,'__LTE__')
      .replace(/!=/g,'__NE__');
    expr = expr.replace(/=/g,'==');
    expr = expr.replace(/__GTE__/g,'>=')
               .replace(/__LTE__/g,'<=')
               .replace(/__NE__/g,'!=');
    expr = expr.replace(/\bAND\b/gi,'&&').replace(/\bOR\b/gi,'||');
    // Allow numeric sex in preview: sex == 1/0 → 'Male'/'Female'
    expr = expr.replace(/\bsex\s*==\s*1\b/gi, "sex=='Male'")
               .replace(/\bsex\s*==\s*0\b/gi, "sex=='Female'")
               .replace(/\bsex\s*!=\s*1\b/gi, "sex!='Male'")
               .replace(/\bsex\s*!=\s*0\b/gi, "sex!='Female'");
    const fn = new Function('r', `with(r){ return ${expr}; }`);
    const res = fn(r);
    customWhere.classList.remove('is-invalid');
    return !!res;
  } catch (e) {
    customWhere.classList.add('is-invalid');
    return false;
  }
}
function filterRecords(){const s=startDate.value?new Date(startDate.value):null;const e=endDate.value?new Date(endDate.value):null;const endInclusive=e?new Date(e.setHours(23,59,59,999)):null;console.log(`Filter range: start=${s?s.toISOString():'none'}, end=${endInclusive?endInclusive.toISOString():'none'}`);const min=Number(minPct.value);const max=Number(maxPct.value);const genders=[];if(genderMale.checked)genders.push('Male');if(genderFemale.checked)genders.push('Female');const diseases=[];if(diseaseYes.checked)diseases.push('Yes');if(diseaseNo.checked)diseases.push('No');return records.filter(r=>{const d=new Date(r.date);const dateOk=(!s||d>=s)&&(!endInclusive||d<=endInclusive);const pctOk=r.risk_pct>=min&&r.risk_pct<=max;const genderOk=genders.includes(r.sex);const diseaseOk=diseases.includes(r.pred_label);const advOk=matchAdvanced(r);return dateOk&&pctOk&&genderOk&&diseaseOk&&advOk;});}
function sortRows(rows){const col=currentSort.col;const dir=currentSort.dir==='asc'?1:-1;return[...rows].sort((a,b)=>{const va=a[col];const vb=b[col];if(typeof va==='number'&&typeof vb==='number')return(va-vb)*dir;return String(va).localeCompare(String(vb))*dir;});}
function renderTable(rows){const thead=document.querySelector('#preview-table thead tr');const tbody=document.querySelector('#preview-table tbody');thead.innerHTML='';visibleCols.forEach(key=>{const col=columnDefs.find(c=>c.key===key);const th=document.createElement('th');th.textContent=col.label;th.dataset.col=key;th.addEventListener('click',()=>{if(currentSort.col===key){currentSort.dir=currentSort.dir==='asc'?'desc':'asc';}else{currentSort.col=key;currentSort.dir='asc';sortBy.value=key;}currentRows=sortRows(currentRows);renderTable(currentRows);renderPagination();});thead.appendChild(th);});tbody.innerHTML='';const start=(currentPage-1)*pageSize;const pageRows=rows.slice(start,start+pageSize);pageRows.forEach(r=>{const tr=document.createElement('tr');visibleCols.forEach(k=>{let val=r[k];if(k==='risk_pct')val=`${r[k].toFixed(1)}%`;const td=document.createElement('td');if(k==='id'&&r.pred_label==='Yes'){td.classList.add('id-risk');}td.textContent=val;tr.appendChild(td);});tbody.appendChild(tr);});}
function renderRiskDistribution(rows){
  try{
    const vals = rows.map(r=>Number(r.risk_pct)).filter(v=>!Number.isNaN(v));
    if(!vals.length){
      document.getElementById('risk-dist').innerHTML = '<div class="text-muted small">No data</div>';
      return;
    }
    let sample = vals;
    if(sample.length > 2000){
      const step = Math.ceil(sample.length / 2000);
      sample = sample.filter((_,i)=>i%step===0);
    }
    const n = sample.length;
    const mean = sample.reduce((s,v)=>s+v,0)/n;
    const variance = sample.reduce((s,v)=>s+(v-mean)*(v-mean),0)/n;
    const sd = Math.sqrt(variance) || 1;
    const bw = 1.06 * sd * Math.pow(n,-1/5);
    const xs=[], ys=[];
    for(let x=0;x<=100;x+=1){
      let sum=0;
      for(const v of sample){ const u=(x-v)/bw; sum+=Math.exp(-0.5*u*u); }
      ys.push(sum/(n*bw*Math.sqrt(2*Math.PI)));
      xs.push(x);
    }
    const hist = {x: vals, type:'histogram', histnorm:'probability density', nbinsx:20, xbins:{start:0,end:100,size:5}, marker:{color:'#93c5fd'}, opacity:0.35, name:'Histogram'};
    const kde  = {x: xs, y: ys, type:'scatter', mode:'lines', line:{color:'#1d4ed8', width:2}, name:'KDE'};
    const layout = {margin:{l:60,r:20,t:10,b:40}, height:320, xaxis:{title:'Risk %', range:[0,100]}, yaxis:{title:'Density'}};
    if(window._rdInited){
      Plotly.react('risk-dist',[hist,kde],layout);
    } else {
      Plotly.newPlot('risk-dist',[hist,kde],layout,{displayModeBar:false,responsive:true});
      window._rdInited = true;
    }
  }catch(e){ console.warn('Risk distribution:', e); }
}
function renderPagination(){const totalPages=Math.ceil(currentRows.length/pageSize)||1;prevPage.disabled=currentPage<=1;nextPage.disabled=currentPage>=totalPages;}
prevPage.addEventListener('click',()=>{if(currentPage>1){currentPage--;renderTable(currentRows);renderPagination();}});
nextPage.addEventListener('click',()=>{const totalPages=Math.ceil(currentRows.length/pageSize);if(currentPage<totalPages){currentPage++;renderTable(currentRows);renderPagination();}});
function update(){
  let rows=filterRecords();
  currentSort.col=sortBy.value;currentSort.dir='asc';
  currentRows=sortRows(rows);currentPage=1;
  recordCount.textContent=currentRows.length;
  renderTable(currentRows);renderPagination();
  renderRiskDistribution(currentRows);
}
update();

</script>
{% endblock %}
