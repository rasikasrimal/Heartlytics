{% extends 'base.html' %}

{% block title %}Sign Up{% endblock %}

{% block navbar %}
<nav class="navbar justify-content-end p-3">
  {% include 'components/theme_toggle.html' %}
</nav>
{% endblock %}

{% block flashes %}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for cat, msg in messages %}
          <div class="alert alert-{{ 'danger' if cat == 'error' else cat }} shadow-sm" role="alert">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
{% endblock %}

{% block content %}
<div class="row justify-content-center fade-in">
  <div class="col-md-6">
    <h2 class="mb-3">Sign Up</h2>
    <form method="post" action="{{ url_for('auth.signup') }}">
      {{ form.csrf_token }}
      <div class="mb-3">
        {{ form.username.label(class='form-label') }}
        {{ form.username(class='form-control') }}
        {% for err in form.username.errors %}
        <div class="text-danger small">{{ err }}</div>
        {% endfor %}
      </div>
      <div class="mb-3">
        {{ form.nickname.label(class='form-label') }}
        {{ form.nickname(class='form-control') }}
        {% for err in form.nickname.errors %}
        <div class="text-danger small">{{ err }}</div>
        {% endfor %}
      </div>
      <div class="mb-3">
        {{ form.email.label(class='form-label') }}
        {{ form.email(class='form-control') }}
        {% for err in form.email.errors %}
        <div class="text-danger small">{{ err }}</div>
        {% endfor %}
      </div>
      <div class="mb-3">
        {{ form.password.label(class='form-label') }}
        {{ form.password(class='form-control') }}
        <div class="progress mt-2" style="height: 5px;">
          <div id="passwordStrength" class="progress-bar" role="progressbar"></div>
        </div>
        <ul class="password-hints list-unstyled small mt-2 mb-0">
          <li><span id="lengthHint" class="text-danger">❌</span> Minimum 8 characters</li>
          <li><span id="uppercaseHint" class="text-danger">❌</span> At least one uppercase letter</li>
          <li><span id="lowercaseHint" class="text-danger">❌</span> At least one lowercase letter</li>
          <li><span id="numberHint" class="text-danger">❌</span> At least one number</li>
          <li><span id="specialHint" class="text-danger">❌</span> At least one special character (!@#$%^&*)</li>
        </ul>
        {% for err in form.password.errors %}
        <div class="text-danger small">{{ err }}</div>
        {% endfor %}
      </div>
      <div class="mb-3">
        {{ form.confirm.label(class='form-label') }}
        {{ form.confirm(class='form-control') }}
        {% for err in form.confirm.errors %}
        <div class="text-danger small">{{ err }}</div>
        {% endfor %}
      </div>
      <div class="mb-3">
        {{ form.role.label(class='form-label') }}
        {{ form.role(class='form-select') }}
        {% for err in form.role.errors %}
        <div class="text-danger small">{{ err }}</div>
        {% endfor %}
      </div>
      {{ form.submit(class='btn btn-primary') }}
    </form>
    <p class="mt-3">Already have an account? <a href="{{ url_for('auth.login') }}">Sign in</a></p>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const pwd = document.getElementById('{{ form.password.id }}');
  const strength = document.getElementById('passwordStrength');
  const hints = {
    length: document.getElementById('lengthHint'),
    uppercase: document.getElementById('uppercaseHint'),
    lowercase: document.getElementById('lowercaseHint'),
    number: document.getElementById('numberHint'),
    special: document.getElementById('specialHint')
  };

  function updateStrength() {
    const val = pwd.value;
    const checks = {
      length: val.length >= 8,
      uppercase: /[A-Z]/.test(val),
      lowercase: /[a-z]/.test(val),
      number: /\d/.test(val),
      special: /[!@#$%^&*]/.test(val)
    };
    let score = 0;
    Object.entries(checks).forEach(([key, passed]) => {
      hints[key].textContent = passed ? '✅' : '❌';
      hints[key].classList.toggle('text-success', passed);
      hints[key].classList.toggle('text-danger', !passed);
      if (passed) score++;
    });
    const percent = (score / 5) * 100;
    strength.style.width = percent + '%';
    strength.className = 'progress-bar';
    if (score <= 2) strength.classList.add('bg-danger');
    else if (score <= 4) strength.classList.add('bg-warning');
    else strength.classList.add('bg-success');

    if (score === 5) {
      pwd.classList.add('is-valid');
      pwd.classList.remove('is-invalid');
    } else {
      pwd.classList.add('is-invalid');
      pwd.classList.remove('is-valid');
    }
  }

  pwd.addEventListener('input', updateStrength);
});
</script>
{% endblock %}

