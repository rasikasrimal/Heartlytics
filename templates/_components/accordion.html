{% macro accordion(id, items) -%}
<div class="accordion" id="{{ id }}">
  {% for item in items %}
  <div class="accordion-item">
    <h2 class="accordion-header" id="{{ id }}-h{{ loop.index }}">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#{{ id }}-c{{ loop.index }}" aria-expanded="false" aria-controls="{{ id }}-c{{ loop.index }}">
        {{ item.title }}
      </button>
    </h2>
    <div id="{{ id }}-c{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#{{ id }}">
      <div class="accordion-body">{{ item.body }}</div>
    </div>
  </div>
  {% endfor %}
  </div>
{%- endmacro %}

{% macro log_accordion(items) -%}
<div class="accordion accordion-flush" id="activityAccordion">
  {% for log in items %}
  <div class="accordion-item">
    <h2 class="accordion-header" id="log-h{{ loop.index }}">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#log-c{{ loop.index }}" aria-expanded="false" aria-controls="log-c{{ loop.index }}">
        <i class="bi bi-circle me-2"></i>
        {{ log.action if log.action is defined else 'Activity' }}
        <span class="ms-auto small text-muted">{{ (log.timestamp.strftime('%Y-%m-%d %H:%M') if log.timestamp is string == false and log.timestamp.strftime is defined else log.timestamp) or '' }}</span>
      </button>
    </h2>
    <div id="log-c{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#activityAccordion">
      <div class="accordion-body small">
        {% set ip = (log.requester_ip if log.requester_ip is defined else (log.ip if log.ip is defined else None)) %}
        {% set ua = (log.user_agent if log.user_agent is defined else None) %}
        {% if ip %}<div><span class="text-muted">IP:</span> {{ ip }}</div>{% endif %}
        {% if ua %}<div><span class="text-muted">Agent:</span> {{ ua }}</div>{% endif %}
        {% if log.acting_user is defined or log.target_user is defined %}
        <div class="mt-2">
          <div><span class="text-muted">By:</span> {{ log.acting_user.username if log.acting_user is defined and log.acting_user else '—' }}</div>
          <div><span class="text-muted">Target:</span> {{ log.target_user.username if log.target_user is defined and log.target_user else '—' }}</div>
          {% if log.old_value is defined or log.new_value is defined %}
          <div><span class="text-muted">Change:</span> {{ (log.old_value or '—') }} → {{ (log.new_value or '—') }}</div>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% else %}
  <div class="text-center text-muted py-5">
    <i class="bi bi-inbox fs-1"></i>
    <p class="mt-3">No activity yet</p>
  </div>
  {% endfor %}
  </div>
{%- endmacro %}

