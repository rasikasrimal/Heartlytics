{% extends "base.html" %}
{% block title %}Preprocess | Heartlytics{% endblock %}
{% block content %}
<h1 class="h4 mb-3">Preview &amp; cleaning</h1>
<div class="table-scroll mb-3">
  <table class="table table-sm table-striped">
    <thead id="preview-head"></thead>
    <tbody id="preview-body"></tbody>
  </table>
</div>

<div class="vstack gap-3">
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Duplicate handling</h2>
        <button class="btn btn-sm btn-brand" data-action="dup">Fix</button>
      </div>
      <div class="mt-2" id="msg-dup"></div>
    </div>
  </div>
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Invalid / implausible values â†’ NaN</h2>
        <button class="btn btn-sm btn-brand" data-action="invalid">Fix</button>
      </div>
      <div class="mt-2" id="msg-invalid"></div>
    </div>
  </div>
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Missing value imputation</h2>
        <button class="btn btn-sm btn-brand" data-action="impute">Fix</button>
      </div>
      <div class="mt-2" id="msg-impute"></div>
    </div>
  </div>
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Outlier handling (IQR-based softening)</h2>
        <button class="btn btn-sm btn-brand" data-action="outliers">Fix</button>
      </div>
      <div class="mt-2" id="msg-outliers"></div>
    </div>
  </div>
</div>

<div class="mt-3">
  <button id="btn-finish" class="btn btn-brand">Run preprocessing</button>
</div>
<!-- detail modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"></div>
    </div>
  </div>
</div>

{% endblock %}



{% block scripts %}
<script>
const uid = "{{ uid }}";
const csrfToken = "{{ csrf_token() }}";
const preview = {{ preview_json|tojson|safe }};
const detailCache = {};

function showModal(modalEl){
  if(window.bootstrap && bootstrap.Modal){
    new bootstrap.Modal(modalEl).show();
  } else {
    modalEl.style.display = 'block';
  }
}
function hideModal(modalEl){
  if(window.bootstrap && bootstrap.Modal){
    const inst = bootstrap.Modal.getInstance(modalEl);
    if(inst) inst.hide();
  } else {
    modalEl.style.display = 'none';
  }
}
document.querySelector('#detailModal .btn-close').addEventListener('click', ()=>hideModal(document.getElementById('detailModal')));

async function parseJson(res){
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { throw new Error(text.slice(0,200)); }
}

function renderPreview(rows){
  if(!rows.length) return;
  const cols = Object.keys(rows[0]);
  const head = '<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr>';
  document.getElementById('preview-head').innerHTML = head;
  const body = rows.map(r=>'<tr>'+cols.map(c=>`<td>${r[c] ?? ''}</td>`).join('')+'</tr>').join('');
  document.getElementById('preview-body').innerHTML = body;
}
renderPreview(preview);

document.querySelectorAll('[data-action]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const act = btn.dataset.action;
    btn.disabled = true;
    const msg = document.getElementById(`msg-${act}`);
    msg.innerHTML = '<div class="alert alert-info small mb-0">Working...</div>';
    try {
      const res = await fetch(`/upload/${uid}/preprocess/${act}`, {method:'POST', headers:{'X-CSRF-Token': csrfToken}});
      const data = await parseJson(res);

      if(!res.ok || !data.ok) throw new Error(data.error || res.status);
      let extraBtn = '';
      if (data.details && data.details.length) {
        detailCache[act] = data.details;
        extraBtn = ' <button class="btn btn-link btn-sm p-0 ms-1" data-detail="'+act+'">View</button>';
      }
      msg.innerHTML = `<div class=\"alert alert-success small mb-0\"><strong>${data.message}</strong><br><span class=\"text-muted\">${data.info}</span>${extraBtn}</div>`;
      renderPreview(data.preview);
    } catch(e) {
      msg.innerHTML = `<div class="alert alert-danger small mb-0">Error: ${e.message}</div>`;

    } finally {
      btn.disabled = false;
    }
  });
});

document.getElementById('btn-finish').addEventListener('click', async function(){
  const btn = this; btn.disabled = true;
  try {
    const res = await fetch(`/upload/${uid}/preprocess/finish`, {method:'POST', headers:{'X-CSRF-Token': csrfToken}});
    const data = await parseJson(res);

    if(!res.ok || !data.ok) throw new Error(data.error || res.status);
    window.location = `/upload/${uid}/eda`;
  } catch(e) {
    alert('Error: '+e.message);
    btn.disabled = false;
  }
});

document.addEventListener('click', function(e){
  const btn = e.target.closest('[data-detail]');
  if(!btn) return;
  const key = btn.getAttribute('data-detail');
  const rows = detailCache[key] || [];
  const body = document.querySelector('#detailModal .modal-body');
  if(!rows.length){ body.innerHTML = '<div class="text-muted">No details</div>'; }
  else {
    const cols = Object.keys(rows[0]);
    let html = '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr>';
    html += cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>';
    html += rows.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]??''}</td>`).join('')+'</tr>').join('');
    html += '</tbody></table></div>';
    body.innerHTML = html;
  }
  showModal(document.getElementById('detailModal'));

});
</script>
{% endblock %}
