{% extends "base.html" %}
{% block title %}Preprocess | Heart Disease Risk{% endblock %}
{% block content %}
<h1 class="h4 mb-3">Preview &amp; cleaning</h1>
<div class="table-scroll mb-3">
  <table class="table table-sm table-striped">
    <thead id="preview-head"></thead>
    <tbody id="preview-body"></tbody>
  </table>
</div>

<div class="vstack gap-3">
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Duplicate handling</h2>
        <button class="btn btn-sm btn-brand" data-action="dup">Fix</button>
      </div>
      <div class="mt-2" id="msg-dup"></div>
    </div>
  </div>
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Invalid / implausible values → NaN</h2>
        <button class="btn btn-sm btn-brand" data-action="invalid">Fix</button>
      </div>
      <div class="mt-2" id="msg-invalid"></div>
    </div>
  </div>
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Rows with missing values</h2>
        {% set miss_pct = (missing_rows * 100 / total_rows) if total_rows else 0 %}
        <button class="btn btn-sm btn-outline-danger" data-action="dropna" {% if missing_rows == 0 or miss_pct > missing_drop_limit_pct %}disabled{% endif %}>Delete all</button>
      </div>
      <div class="mt-2 small text-muted">
        Found <strong id="missing-count">{{ missing_rows }}</strong> of <span id="total-count">{{ total_rows }}</span> rows with at least one missing cell (<span id="missing-pct">{{ '%.1f' % missing_pct }}</span>%).
        Deletion disabled if more than {{ '%.0f' % missing_drop_limit_pct }}% of rows have missing values.
      </div>
      <div class="mt-2" id="msg-dropna"></div>
    </div>
  </div>
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Missing value imputation</h2>
        <button class="btn btn-sm btn-brand" data-action="impute">Fix</button>
      </div>
      <div class="mt-2" id="msg-impute"></div>
    </div>
  </div>
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Outlier handling (IQR-based softening)</h2>
        <button class="btn btn-sm btn-brand" data-action="outliers">Fix</button>
      </div>
      <div class="mt-2" id="msg-outliers"></div>
    </div>
  </div>
</div>

<div class="mt-3">
  <button id="btn-finish" class="btn btn-brand">Run preprocessing</button>
</div>
<!-- detail modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"></div>
    </div>
  </div>
</div>

{% endblock %}



{% block scripts %}
<script>
const uid = "{{ uid }}";
const csrfToken = "{{ csrf_token() }}";
const preview = {{ preview_json|tojson|safe }};
const detailCache = {};
const DROP_LIMIT_PCT = {{ (missing_drop_limit_pct or 30) | int }};

function showModal(modalEl){
  if(window.bootstrap && bootstrap.Modal){
    new bootstrap.Modal(modalEl).show();
  } else {
    modalEl.style.display = 'block';
  }
}
function hideModal(modalEl){
  if(window.bootstrap && bootstrap.Modal){
    const inst = bootstrap.Modal.getInstance(modalEl);
    if(inst) inst.hide();
  } else {
    modalEl.style.display = 'none';
  }
}
document.querySelector('#detailModal .btn-close').addEventListener('click', ()=>hideModal(document.getElementById('detailModal')));

async function parseJson(res){
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { throw new Error(text.slice(0,200)); }
}

function renderPreview(rows){
  if(!rows.length) return;
  const cols = Object.keys(rows[0]);
  const head = '<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr>';
  document.getElementById('preview-head').innerHTML = head;
  const body = rows.map(r=>'<tr>'+cols.map(c=>`<td>${r[c] ?? ''}</td>`).join('')+'</tr>').join('');
  document.getElementById('preview-body').innerHTML = body;
}
renderPreview(preview);

document.querySelectorAll('[data-action]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const act = btn.dataset.action;
    btn.disabled = true;
    const msg = document.getElementById(`msg-${act}`);
    msg.innerHTML = '<div class="alert alert-info small mb-0">Working...</div>';
    try {
      const res = await fetch(`/upload/${uid}/preprocess/${act}`, {method:'POST', headers:{'X-CSRF-Token': csrfToken}});
      const data = await parseJson(res);

      if(!res.ok || !data.ok) throw new Error(data.error || res.status);
      let extraBtn = '';
      if (data.details && data.details.length) {
        detailCache[act] = data.details;
        extraBtn = ' <button class="btn btn-link btn-sm p-0 ms-1" data-detail="'+act+'">View</button>';
      }
      msg.innerHTML = `<div class=\"alert alert-success small mb-0\"><strong>${data.message}</strong><br><span class=\"text-muted\">${data.info}</span>${extraBtn}</div>`;
      renderPreview(data.preview);
      // Update missing counts if provided
      if (typeof data.missing_rows === 'number') {
        const mc = document.getElementById('missing-count');
        if (mc) mc.textContent = data.missing_rows;
      }
      if (typeof data.total_rows === 'number') {
        const tc = document.getElementById('total-count');
        if (tc) tc.textContent = data.total_rows;
      }
      // Apply threshold-based disable logic and update percent label
      const dropBtn = document.querySelector('[data-action="dropna"]');
      const mcVal = Number(document.getElementById('missing-count')?.textContent || 0);
      const tcVal = Number(document.getElementById('total-count')?.textContent || 0);
      const pct = tcVal ? Math.round((mcVal / tcVal) * 1000) / 10 : 0;
      const pctEl = document.getElementById('missing-pct');
      if (pctEl) pctEl.textContent = pct.toFixed(1);
      if (dropBtn) dropBtn.disabled = (mcVal === 0) || (tcVal > 0 && pct > DROP_LIMIT_PCT);
    } catch(e) {
      msg.innerHTML = `<div class="alert alert-danger small mb-0">Error: ${e.message}</div>`;

    } finally {
      btn.disabled = false;
    }
  });
});

document.getElementById('btn-finish').addEventListener('click', async function(){
  const btn = this; btn.disabled = true;
  try {
    const res = await fetch(`/upload/${uid}/preprocess/finish`, {method:'POST', headers:{'X-CSRF-Token': csrfToken}});
    const data = await parseJson(res);

    if(!res.ok || !data.ok) throw new Error(data.error || res.status);
    window.location = `/upload/${uid}/eda`;
  } catch(e) {
    alert('Error: '+e.message);
    btn.disabled = false;
  }
});

document.addEventListener('click', function(e){
  const btn = e.target.closest('[data-detail]');
  if(!btn) return;
  const key = btn.getAttribute('data-detail');
  const rows = detailCache[key] || [];
  const body = document.querySelector('#detailModal .modal-body');
  if(!rows.length){ body.innerHTML = '<div class="text-muted">No details</div>'; }
  else {
    const cols = Object.keys(rows[0]);
    let html = '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr>';
    html += cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>';
    html += rows.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]??''}</td>`).join('')+'</tr>').join('');
    html += '</tbody></table></div>';
    body.innerHTML = html;
  }
  showModal(document.getElementById('detailModal'));

});
</script>
<script>
// Add inline help popovers for each step
(function(){
  function addHelp(h2, title, content){
    if(!h2 || h2.querySelector('[data-bs-toggle="popover"]')) return;
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-link btn-sm p-0 align-baseline ms-1';
    btn.setAttribute('data-bs-toggle', 'popover');
    btn.setAttribute('data-bs-placement', 'top');
    btn.setAttribute('title', title);
    btn.setAttribute('data-bs-content', content);
    btn.innerHTML = '<i class="bi bi-question-circle"></i>';
    h2.appendChild(btn);
    if (window.bootstrap && bootstrap.Popover){ new bootstrap.Popover(btn, { trigger: 'hover focus', container: 'body' }); }
  }
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('h2.h6.mb-0').forEach(function(h2){
      const t = (h2.textContent||'').trim();
      if(t.startsWith('Duplicate handling')){
        addHelp(h2, 'What it does', 'Removes exact duplicate rows using pandas drop_duplicates (keeps the first occurrence). Shows a sample of removed rows if any.');
      } else if(t.startsWith('Invalid / implausible values')){
        addHelp(h2, 'What it does', 'Replaces impossible or out-of-range values with NaN so they can be imputed. Examples: negative ages, zero/negative cholesterol, physiologically implausible measures.');
      } else if(t.startsWith('Missing value imputation')){
        addHelp(h2, 'What it does', 'Fills missing values. Numeric columns use the median; categorical columns use a simple model-based imputer to predict missing entries.');
      } else if(t.startsWith('Outlier handling')){
        addHelp(h2, 'How IQR softening works', 'For each numeric column, compute Q1 and Q3; IQR = Q3 − Q1. Values below Q1 − 1.5×IQR are clipped up; values above Q3 + 1.5×IQR are clipped down.');
      }
    });
  });
})();
</script>
{% endblock %}
