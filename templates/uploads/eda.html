{% extends "base.html" %}
{% block title %}EDA & Cleaning | Heart Disease Risk{% endblock %}
{% block head %}
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" defer></script>
{% endblock %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <h1 class="h5 mb-0">CSV Cleaning &amp; EDA</h1>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="{{ url_for('upload_download_clean', uid=uid) }}">Download Cleaned CSV</a>
        {% if has_results %}
          <a class="btn btn-success" href="{{ url_for('upload_download_results', uid=uid) }}">Download Results CSV</a>
          <a class="btn btn-brand" href="{{ url_for('upload_bulk_pdf', uid=uid) }}">Bulk PDF</a>
        {% else %}
          <form action="{{ url_for('upload_predict', uid=uid) }}" method="post" class="d-inline">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-brand" type="submit">Run Batch Predictions</button>
          </form>
        {% endif %}
      </div>
    </div>
    {% if banner %}
      <div class="alert alert-success mt-3">{{ banner }}</div>
    {% endif %}
    {% if predict_notice %}
      <div class="predict-notice mt-2 mb-0">{{ predict_notice }}</div>
    {% endif %}

    {% if cleaning_log|length > (predict_notice and 1 or 0) %}
    <div class="d-flex justify-content-between align-items-center mt-3">
      <h2 class="h6 mb-0">Cleaning Log</h2>
      <button class="btn btn-sm btn-outline-secondary" id="cleaning-log-view" type="button">View</button>
    </div>
    {% set groups = cleaning_groups %}
    <div class="cleaning-log border rounded p-2 small table-scroll">
      <ul class="mb-0 ps-3">
        {% if groups['dup'] %}
        <li><strong>‚úÖ Duplicates removed</strong><ul>{% for item in groups['dup'] %}<li>{{ item.text }}{% if item.details %}<button class="btn btn-link btn-sm p-0 ms-1 log-view" data-detail="{{ item.idx }}">View</button>{% endif %}</li>{% endfor %}</ul></li>{% endif %}
        {% if groups['invalid'] %}
        <li class="mt-1"><strong>‚ö†Ô∏è Invalid values ‚Üí NaN</strong><ul>{% for item in groups['invalid'] %}<li>{{ item.text }}{% if item.details %}<button class="btn btn-link btn-sm p-0 ms-1 log-view" data-detail="{{ item.idx }}">View</button>{% endif %}</li>{% endfor %}</ul></li>{% endif %}
        {% if groups['impute'] %}
        <li class="mt-1"><strong>‚úÖ Missing value imputation</strong><ul>{% for item in groups['impute'] %}<li>{{ item.text }}{% if item.details %}<button class="btn btn-link btn-sm p-0 ms-1 log-view" data-detail="{{ item.idx }}">View</button>{% endif %}</li>{% endfor %}</ul></li>{% endif %}
        {% if groups['outliers'] %}
        <li class="mt-1"><strong>üìä Outliers softened</strong><ul>{% for item in groups['outliers'] %}<li>{{ item.text }}{% if item.details %}<button class="btn btn-link btn-sm p-0 ms-1 log-view" data-detail="{{ item.idx }}">View</button>{% endif %}</li>{% endfor %}</ul></li>{% endif %}
        {% for item in groups['other'] %}<li class="mt-1">{{ item.text }}{% if item.details %}<button class="btn btn-link btn-sm p-0 ms-1 log-view" data-detail="{{ item.idx }}">View</button>{% endif %}</li>{% endfor %}
      </ul>
    </div>
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mt-3">
      <h2 class="h6 mb-0">Preview (first 20 rows)</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" id="preview-view">View</button>
        <button class="btn btn-sm btn-brand" id="preview-more">Load more</button>
      </div>
    </div>
    <div class="table-scroll">

      <table class="table table-sm table-striped table-hover">
        <thead id="preview-head"></thead>
        <tbody id="preview-body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Outlier handling -->
<div class="card shadow-sm mt-3" id="outlier-card" style="display:none;">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <h2 class="h6 mb-0">Outlier handling</h2>
      <div class="d-flex gap-2">
        <button id="out-delete-all" class="btn btn-sm btn-outline-danger">Delete all</button>

      </div>
    </div>
    <div id="out-msg" class="small mt-2"></div>
    <div class="table-responsive mt-2 table-scroll">
      <table class="table table-sm table-striped table-hover align-middle">
        <thead>
          <tr><th>ID</th><th>Issues</th><th>Pred</th><th>Risk %</th><th></th></tr>
        </thead>
        <tbody id="out-body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Visualizations -->
<div class="row g-3 mt-3">
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h3 class="h6 mb-0">Summary Statistics</h3>
          <button class="btn btn-sm btn-outline-secondary" data-view="#stats-table" data-title="Summary Statistics">View</button>
        </div>
        <div id="stats-table" class="table-responsive mt-2"></div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h3 class="h6 mb-0">Correlation Heatmap (numeric)</h3>
          <button class="btn btn-sm btn-outline-secondary" data-view="#corr-heatmap" data-title="Correlation Heatmap">View</button>
        </div>
        <div id="corr-heatmap" class="chart-md"></div>
      </div>
    </div>
  </div>
</div>

<!-- view modal -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewTitle">View</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body"></div>
    </div>
  </div>
</div>

<!-- confirm delete modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><span class="text-danger me-2">‚ö†Ô∏è</span>Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="confirmMsg">Are you sure?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light btn-transition" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger btn-transition" id="confirmDelete">Delete</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
window.addEventListener('load', function(){
  const preview = {{ preview_json|safe if preview_json is defined else '[]' }};
  const uid = {{ uid|tojson }};
  const eda = {{ eda_json|safe if eda_json is defined else '{}' }};
  const logDetails = {{ cleaning_log_json|safe if cleaning_log_json is defined else '[]' }};
  let outliers = {{ outliers_json|safe if outliers_json is defined else '[]' }};
  const csrfToken = {{ csrf_token()|tojson }};
  const confirmModalEl = document.getElementById('confirmModal');
  const confirmMsg = document.getElementById('confirmMsg');
  const confirmDelete = document.getElementById('confirmDelete');
  let confirmAction = null;
  confirmDelete.addEventListener('click', async () => {
    if(!confirmAction) return;
    confirmDelete.disabled = true;
    const oldHtml = confirmDelete.innerHTML;
    confirmDelete.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Deleting‚Ä¶';
    try { await confirmAction(); }
    finally {
      confirmDelete.disabled = false;
      confirmDelete.innerHTML = oldHtml;
      hideModal(confirmModalEl);
      confirmAction = null;
    }
  });

  function showModal(modalEl){
    if(window.bootstrap && bootstrap.Modal){
      new bootstrap.Modal(modalEl).show();
    } else {
      modalEl.style.display = 'block';
    }

  }
  function hideModal(modalEl){
    if(window.bootstrap && bootstrap.Modal){
      const inst = bootstrap.Modal.getInstance(modalEl);
      if(inst) inst.hide();
    } else {
      modalEl.style.display = 'none';
    }
  }
  document.querySelector('#viewModal .btn-close').addEventListener('click', ()=>hideModal(document.getElementById('viewModal')));

  // ----- Preview table -----
  const previewHead = document.getElementById('preview-head');
  const previewBody = document.getElementById('preview-body');
  const btnMore = document.getElementById('preview-more');
  let previewLoaded = 0;
  let previewCols = [];
  const PREVIEW_STEP = 20;

  function appendPreviewRows(rows){
    if(!rows.length) return;
    const cols = previewLoaded === 0 ? Object.keys(rows[0]) : previewCols;
    if(previewLoaded === 0){
      previewCols = cols;
      previewHead.innerHTML = '<tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr>';
    }
    previewBody.insertAdjacentHTML('beforeend', rows.map(r => '<tr>' + cols.map(c => `<td>${r[c] ?? ''}</td>`).join('') + '</tr>').join(''));
    previewLoaded += rows.length;
    if(rows.length < PREVIEW_STEP) btnMore.disabled = true;
  }
  if(Array.isArray(preview) && preview.length){ appendPreviewRows(preview); }
  else { previewBody.innerHTML = '<tr><td class="text-muted">No rows</td></tr>'; btnMore.disabled = true; }
  btnMore.addEventListener('click', async () => {
    try {
      const res = await fetch(`/upload/${uid}/preview?start=${previewLoaded}&limit=${PREVIEW_STEP}`);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      appendPreviewRows(data.rows || []);
    } catch(err){ alert('Failed to load rows'); }
  });
  document.getElementById('preview-view').addEventListener('click', async () => {
    try {
      const res = await fetch(`/upload/${uid}/preview?start=0&limit=1000`);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const rows = data.rows || [];
      const body = document.querySelector('#viewModal .modal-body');
      if(!rows.length){ body.innerHTML = '<div class="text-muted">No rows</div>'; }
      else {
        const cols = Object.keys(rows[0]);
        let html = '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>';
        html += rows.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]??''}</td>`).join('')+'</tr>').join('') + '</tbody></table></div>';
        body.innerHTML = html;
      }
      document.getElementById('viewTitle').textContent = 'Dataset Preview';
      showModal(document.getElementById('viewModal'));
    } catch(err){ alert('Failed to load preview'); }
  });

  // ----- Outlier handling -----
  const outCard = document.getElementById('outlier-card');
  const outTbody = document.getElementById('out-body');
  const outMsg = document.getElementById('out-msg');
  const btnOutDelAll = document.getElementById('out-delete-all');
  function riskBadge(p){
    if (p < 20) return `<span class="badge bg-success">${p.toFixed(1)}%</span>`;
    if (p < 50) return `<span class="badge bg-warning text-dark">${p.toFixed(1)}%</span>`;
    return `<span class="badge bg-danger">${p.toFixed(1)}%</span>`;
  }
  function renderOutliers(){
    if (!outliers.length){
      outTbody.innerHTML = '<tr><td colspan="5" class="text-muted small">No outliers detected</td></tr>';
      btnOutDelAll.disabled = true;
      return;
    }
    outCard.style.display = '';
    const html = outliers.map(r => `
      <tr data-id="${r.db_id}">
        <td>${r.db_id}</td>
        <td class="text-capitalize">${r.outlier_cols}</td>
        <td><span class="badge ${r.prediction ? 'bg-danger' : 'bg-success'}">${r.prediction ? 'Yes' : 'No'}</span></td>
        <td>${riskBadge((r.positive_probability ?? 0)*100)}</td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary btn-view" data-id="${r.db_id}">View</button>
            <button class="btn btn-outline-secondary btn-ignore" data-id="${r.db_id}">Ignore</button>
            <button class="btn btn-outline-danger btn-delete" data-id="${r.db_id}">Delete</button>
          </div>
        </td>
      </tr>`).join('');
    outTbody.innerHTML = html;
    btnOutDelAll.disabled = false;
  }
  renderOutliers();
  outTbody.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-ignore');
    if(!btn) return;
    const id = Number(btn.dataset.id);
    outliers = outliers.filter(r => r.db_id !== id);
    renderOutliers();
  });
  outTbody.addEventListener('click', async function(e){
    const btn = e.target.closest('.btn-delete');
    if(!btn) return;
    const id = Number(btn.dataset.id);
    btn.disabled = true;
    try{
      const res = await fetch(`/api/predictions/${id}`, {method:'DELETE', headers:{'X-CSRF-Token': csrfToken}, credentials:'same-origin'});
      const data = await res.json();
      if(!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
      outliers = outliers.filter(r => r.db_id !== id);
      renderOutliers();
    }catch(err){ alert('Could not delete: '+err.message); btn.disabled=false; }
  });
  btnOutDelAll.addEventListener('click', function(){
    if(!outliers.length) return;
    const n = outliers.length;
    confirmMsg.textContent = `Are you sure you want to delete all outliers? This action cannot be undone. ${n} record${n===1?'':'s'} will be deleted.`;
    confirmAction = async function(){
      btnOutDelAll.disabled = true;
      try{
        const ids = outliers.map(r => r.db_id);
        const res = await fetch('/api/outliers', {
          method:'DELETE',
          headers:{'Content-Type':'application/json','X-CSRF-Token': csrfToken},
          credentials:'same-origin',
          body: JSON.stringify({ids})
        });
        const data = await res.json();
        if(!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
        outliers = [];
        outMsg.textContent = `${data.deleted} outliers deleted`;
        renderOutliers();
      }catch(err){
        alert('Could not delete: '+err.message);
      }finally{
        btnOutDelAll.disabled = false;
      }
    };
    showModal(confirmModalEl);
  });
  outTbody.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-view');
    if(!btn) return;
    const id = Number(btn.dataset.id);
    const row = outliers.find(r => r.db_id === id);
    if(!row) return;
    const cols = Object.keys(row);
    let html = '<div class="table-responsive"><table class="table table-sm table-striped"><tbody>';
    html += cols.map(c => `<tr><th>${c}</th><td>${row[c]}</td></tr>`).join('');
    html += '</tbody></table></div>';
    const body = document.querySelector('#viewModal .modal-body');
    body.innerHTML = html;
    document.getElementById('viewTitle').textContent = 'Record details';
    showModal(document.getElementById('viewModal'));
  });

  // ----- Charts -----
  const stats = eda.stats || {};
  const corr = eda.corr || null;
  const STAT_ORDER = ['mean','std','min','25%','50%','75%','max'];
  const statsTable = document.getElementById('stats-table');
  if(Object.keys(stats).length){
    const cols = Object.keys(stats);
    const fmt = v => (typeof v === 'number') ? (Math.round(v*100)/100).toString() : v;
    let html = '<table class="table table-sm table-striped"><thead><tr><th>stat</th>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>';
    STAT_ORDER.forEach(r => {
      if(stats[cols[0]][r] !== undefined){
        html += '<tr><th>'+r+'</th>' + cols.map(c=>`<td>${fmt(stats[c][r])}</td>`).join('') + '</tr>';
      }
    });
    html += '</tbody></table>';
    statsTable.innerHTML = html;
  } else { statsTable.innerHTML = '<div class="text-muted">No numeric columns</div>'; }

  if(corr && window.Plotly){
    Plotly.newPlot('corr-heatmap', [{z: corr.z||[], x: corr.x||[], y: corr.y||[], type:'heatmap', colorscale:'Viridis', zmin:-1, zmax:1, hovertemplate:'%{y} vs %{x}<br>r=%{z:.2f}<extra></extra>'}], {margin:{l:100,r:10,t:10,b:80}}, {displayModeBar:false, responsive:true});
  }

  // ----- View buttons (delegated) -----
  document.addEventListener('click', function(e){
    const btn = e.target.closest('[data-view]');
    if(!btn) return;
    const target = btn.dataset.view;
    const title = btn.dataset.title || 'View';
    const modalEl = document.getElementById('viewModal');
    const body = modalEl.querySelector('.modal-body');
    body.innerHTML = '';
    if (target === '#stats-table') {
      body.innerHTML = document.getElementById('stats-table').innerHTML;
    } else if (target === '#corr-heatmap' && corr && window.Plotly) {
      body.innerHTML = '<div id="modal-corr" style="height:600px;"></div>';
      Plotly.newPlot('modal-corr', [{z: corr.z||[], x: corr.x||[], y: corr.y||[], type:'heatmap', colorscale:'Viridis', zmin:-1, zmax:1, hovertemplate:'%{y} vs %{x}<br>r=%{z:.2f}<extra></extra>'}], {margin:{l:100,r:10,t:10,b:80}});
    }
    document.getElementById('viewTitle').textContent = title;
    showModal(modalEl);
  });

  // Single "View" for entire cleaning log
  function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function renderFullCleaningLog(){
    const byStep = { dup:[], invalid:[], impute:[], outliers:[], other:[] };
    (logDetails || []).forEach(it => { const k = it.step || 'other'; (byStep[k]||byStep.other).push(it); });
    const titles = { dup:'Duplicates removed', invalid:'Invalid values ‚Üí NaN', impute:'Missing value imputation', outliers:'Outliers softened', other:'Other' };
    let html = '';
    ['dup','invalid','impute','outliers','other'].forEach(k => {
      const arr = byStep[k]; if(!arr.length) return;
      html += `<h6 class="mt-2">${esc(titles[k])}</h6>`;
      html += '<ul class="small">' + arr.map(it => `<li>${esc(it.text||'')}</li>`).join('') + '</ul>';
    });
    if(!html) html = '<div class="text-muted small">No cleaning log entries</div>';
    const modalEl = document.getElementById('viewModal');
    modalEl.querySelector('.modal-body').innerHTML = html;
    document.getElementById('viewTitle').textContent = 'Cleaning Log';
    showModal(modalEl);
  }
  const btnLog = document.getElementById('cleaning-log-view');
  if (btnLog) btnLog.addEventListener('click', renderFullCleaningLog);
});

</script>
{% endblock %}
