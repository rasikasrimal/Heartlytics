{% extends 'base.html' %}
{% block title %}Settings{% endblock %}
{% from 'components/forms.html' import text_input, email_input, password_input, file_input %}
{% block content %}
<h1 class="mb-4">Settings</h1>
<div class="row g-4">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header">Profile</div>
      <div class="card-body">
        <form method="post" action="{{ url_for('settings.update_profile') }}" enctype="multipart/form-data">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          {{ text_input('username', 'Username', value=current_user.username) }}
          {{ email_input('email', 'Email', value=current_user.email) }}
          {{ text_input('nickname', 'Nickname', value=current_user.nickname) }}
          {{ file_input('avatar', 'Avatar') }}
          <button class="btn btn-brand" type="submit">Save Profile</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header">Change Password</div>
      <div class="card-body">
        <form method="post" action="{{ url_for('settings.update_password') }}">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
            {{ password_input('current_password', 'Current Password', attrs={'autocomplete': 'off'}) }}
            {{ password_input('new_password', 'New Password', attrs={'id': 'new_password', 'autocomplete': 'new-password'}) }}
            {{ password_input('confirm_password', 'Confirm New Password', attrs={'id': 'confirm_password', 'autocomplete': 'new-password'}) }}
          <div id="password-match" class="small mt-2"></div>
          <button class="btn btn-brand" type="submit" id="password-submit" disabled>Update Password</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header">Theme</div>
      <div class="card-body">
        <select id="theme-select" class="form-select" aria-label="Color theme">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="system">System</option>
        </select>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header">Two-Step Verification</div>
      <div class="card-body">
        {% if current_user.mfa_enabled %}
          <p>Two-step verification is enabled.</p>
          <a class="btn btn-danger me-2" href="{{ url_for('auth.mfa_disable') }}">Disable</a>
          <form method="post" action="{{ url_for('auth.mfa_regenerate_codes') }}" class="d-inline">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-secondary" type="submit">Regenerate Codes</button>
          </form>
        {% else %}
          <p>Protect your account with an extra step during login.</p>
          <a class="btn btn-brand" href="{{ url_for('auth.mfa_setup') }}">Enable</a>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header">Email Codes</div>
      <div class="card-body">
        {% if current_user.mfa_email_enabled %}
          <p>Email codes are enabled.</p>
          <a class="btn btn-danger me-2" href="{{ url_for('auth.mfa_email_disable') }}">Disable</a>
        {% else %}
          <p>Receive one-time codes by email during login.</p>
          <a class="btn btn-brand" href="{{ url_for('auth.mfa_email_setup') }}">Enable</a>
        {% endif %}
      </div>
    </div>
  </div>
  {% if current_user.role == 'SuperAdmin' %}
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header">Customize App</div>
      <div class="card-body">
        <form method="post" action="{{ url_for('settings.update_branding') }}" enctype="multipart/form-data">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          {{ text_input('app_name', 'App Name', value=app_name) }}
          {{ file_input('logo', 'Upload Logo') }}
          <button class="btn btn-brand" type="submit">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header">Activity Log</div>
      <ul class="list-group list-group-flush">
      {% for log in logs %}
        <li class="list-group-item small">{{ log.timestamp }} - {{ log.action }}</li>
      {% else %}
        <li class="list-group-item small">No activity</li>
      {% endfor %}
      </ul>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const np = document.getElementById('new_password');
  const cp = document.getElementById('confirm_password');
  const msg = document.getElementById('password-match');
  const btn = document.getElementById('password-submit');
  function check(){
    if(!np.value || !cp.value){
      msg.textContent = '';
      btn.disabled = true;
      return;
    }
    if(np.value === cp.value){
      msg.textContent = '✅ passwords match';
      msg.classList.remove('text-danger');
      msg.classList.add('text-success');
      btn.disabled = false;
    } else {
      msg.textContent = '❌ passwords don\u2019t match';
      msg.classList.remove('text-success');
      msg.classList.add('text-danger');
      btn.disabled = true;
    }
  }
  np.addEventListener('input', check);
  cp.addEventListener('input', check);
  const select = document.getElementById('theme-select');
  if (select){
    select.value = localStorage.getItem('theme') || 'light';
    select.addEventListener('change', (e) => window.setTheme(e.target.value));
  }
});
</script>
{% endblock %}
